!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.r46v3=t():e.r46v3=t()}(this,function(){return function(e){function t(n){if(r[n])return r[n].exports;var i=r[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var r={};return t.m=e,t.c=r,t.i=function(e){return e},t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=40)}([function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=function(){function e(){n(this,e)}return i(e,null,[{key:"get",value:function(e){if(localStorage.getItem(e))return localStorage.getItem(e);if(sessionStorage.getItem(e))return sessionStorage.getItem(e);var t=document.cookie.match(RegExp("(?:^|; )"+e.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return t?decodeURIComponent(t[1]):""}},{key:"set",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;try{e.match(/_device_id$/)&&n&&!n.label.gdpr()&&localStorage.setItem(e,t)}catch(e){console.error("Storage is not allowed")}r=r||{};var i=r.expires;if("number"==typeof i&&i){var o=new Date;o.setTime(o.getTime()+1e3*i),i=r.expires=o}i&&i.toUTCString&&(r.expires=i.toUTCString()),t=encodeURIComponent(t);var a=e+"="+t;for(var s in r){a+="; "+s;var c=r[s];!0!==c&&(a+="="+c)}document.cookie=a}}]),e}();t.default=o},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),l=r(0),u=n(l),d=r(27),h=n(d),p=r(8),f=n(p),m=r(7),g=n(m),b=r(14),v=n(b),y=r(13),_=n(y),w=r(4),k=n(w),x=r(15),S=n(x),E=r(16),P=n(E),C=r(19),A=n(C),N=r(25),q=n(N),j=r(28),T=n(j),O=r(17),I=n(O),L=r(23),R=n(L),M=r(24),U=n(M),B=r(21),z=n(B),D=r(9),W=n(D),H=r(3),F=n(H),G=r(29),J=n(G),V=r(5),Y=n(V),$=r(18),Q=n($),X=r(26),K=n(X),Z=function(e){function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};i(this,t);var n=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,new g.default(r)));return n.label=r.label,navigator.cookieEnabled&&"optout"!==u.default.get(n.label.name()+"_personalization_opt_out")?(n.detectPrivateMode(),n.domOnLoaded(),n.initRetries=0,n.user={did:null,id:null,email:null,profile:null,location:null,seance:null,tz:null},n.shop={token:null,currency:null,recommendations:!0,recommendersLazyLoad:!("false"===u.default.get(n.label.fullName()+"_lazy_recommenders"))},n.stream=null,n.recommendedBy=null,n.recommendedCode=null,n.source=null,n.initializeSegment(),n.collectedEmail=null,n.testMode=!1,n.testRecommenderMode=!1,n.promocode=new A.default(n).getFromCookie(),n.api=new v.default(window[n.label.fullName()+"_env"]||n.label.env,r.host,r.master_host,r.pictures_host),n.ajax=new _.default(n),n.reputation=new R.default(n),t.isBot(n)?(n.logger.debug("Bot detected"),o(n)):!1===t.corsAvailable()?(n.logger.debug("Very old browser"),o(n)):(n.addPreConnectedLinkToPage(n.api.getHost()),n.addPreConnectedLinkToPage(n.api.getPicturesHost()),n.registerSources(),n.init(),f.default.initDynamic(n),f.default.initCategory(n),U.default.initFullSearch(n),K.default.init(n),n)):(n.logger.warn("You have disabled cookies"),o(n))}return a(t,e),c(t,[{key:"init",value:function(){var e=this;try{var t=this.queue.getInit();if(!t[1])return void console.error(this.label.fullName().toUpperCase()+": Incorrect shop_id");"string"==typeof t[2]&&(t[2].length<=16?this.stream=t[2]:this.logger.error("Stream max length 16"));var r={did:u.default.get(this.label.fullName()+"_device_id")||"",shop_id:t[1].trim()};if(this.shop.token=r.shop_id,this.user.did=r.did,this.user.tz=-1*Math.floor((new Date).getTimezoneOffset()/60),u.default.get(this.label.fullName()+"_session_code")){var n=u.default.get(this.label.fullName()+"_session_last_act");n&&parseInt(n)>=(new Date).getTime()-72e5&&(r.sid=u.default.get(this.label.fullName()+"_session_code"),r.seance=r.sid)}this.user&&this.user.email&&(r.user_email=this.user.email),this.source&&this.source.from&&(r.from=this.source.from,r.code=this.source.code,this.source.map&&(r.map=this.source.map)),this.user&&this.user.tz&&(r.tz=this.user.tz);var i=t["string"==typeof t[2]?3:2]||null,o=t["string"==typeof t[2]?4:3]||null;this.ajax.sendGet(this.api.getAPIUrl("/init"),r).then(function(r){if(void 0!==r.opt_out&&"enabled"===r.opt_out)return void e.logger.warn("You have disabled cookies");e.logger.debug("Application initialized"),e.initialized=!0;var n=!!e.user.did;e.user.did=r.did,e.setSeance(r.seance),e.label.gdpr()&&u.default.get(e.label.fullName()+"_device_id")||u.default.set(e.label.fullName()+"_device_id",e.user.did,{expires:31536e3,path:"/"},e),e.fetchSourceFromStore(),n||(f.default.initDynamic(e),f.default.initCategory(e)),K.default.init(e),e.user.profile=r.profile,e.shop.currency=r.currency,e.shop.token=t[1],e.shop.has_email=r.has_email,e.shop.email_collector=r.email_collector,e.shop.recommendations=r.recommendations,e.shop.recommendersLazyLoad=r.lazy_load||!1,e.label.gdpr()||u.default.set(e.label.fullName()+"_lazy_recommenders",e.shop.recommendersLazyLoad,{path:"/"},e),r.voice&&(e.speech=new W.default(e,{codec:r.voice_codec})),r.search&&r.search.enabled&&(e.search=r.search,U.default.initInstantSearch(e),U.default.initFullSearch(e)),r.auto_css_recommender&&e.addStyleToPage("shop_css"),r.web_push_settings&&(e.web_push=new J.default(e,r.web_push_settings)),r.popup&&F.default.prepare(e,r.popup),e.recone=new z.default(e,r.recone),e.performCookieQueue(),"bitrix"===r.cms&&setInterval(e.performCookieQueue.bind(e),1e3),e.performQueue(),e.performErrorQueue(),e.email_collector(),"function"==typeof i&&i(r),r.snippets&&r.snippets.length>0&&r.snippets.forEach(function(t){try{var r=RegExp("(<\\/?script>|\\r?\\n|\\r)","ig"),n=t.code.replace(r,"");if(n.length>0){var i=document.createElement("script");i.dataset[e.label.fullName()+"_snippet_id"]=t.id,i.textContent="(function(){"+n+"})();",document.body?document.body.appendChild(i):document.head?document.head.appendChild(i):e.logger.error("Snippet execution failed: "+t.name)}}catch(r){e.logger.error("Snippet execution failed: "+t.name),e.logger.error(r)}})}).catch(function(r){e.logger.error(r,e),e.initRetries<2?(e.initRetries++,setTimeout(function(){e.push(t),e.init()},2e3)):"function"==typeof o&&o()})}catch(e){this.logger.error(e.message+":"+e.stack,this)}}},{key:"setSeance",value:function(e){this.user.seance=e,u.default.set(this.label.fullName()+"_session_code",e,{path:"/"},this),u.default.set(this.label.fullName()+"_session_last_act",""+(new Date).getTime(),{expires:7200,path:"/"},this)}},{key:"registerSources",value:function(){var e=t.getUrlVars(this);this.vars=e,this.fetchRecommendedBy(e),this.source=this.fetchSources(e),this.search_query=e[this.label.name()+"_search_query"]||e.search||e.query||e.q,this.input_query=e[this.label.name()+"_input_query"],this.trackUTM(e),this.switchTestMode(e),this.switchNewRecommenderMode(e)}},{key:"initializeSegment",value:function(){this.label.gdpr()?this.segment=["A","B"][Math.round(Math.random())]:(this.segment=localStorage.getItem(this.label.name()+"_segment"),this.segment||(this.segment=["A","B"][Math.round(Math.random())],localStorage.setItem(this.label.name()+"_segment",this.segment)))}},{key:"fetchSources",value:function(e){var t={};return-1!==["bulk","chain","transactional"].indexOf(e.recommended_by)&&(e.bulk_code||e.mail_code)&&(t.from=e.recommended_by,t.code=e.bulk_code||e.mail_code,e.utm_link_map&&(t.map=e.utm_link_map)),"chain"===e.recommended_by&&e[this.label.fullName()+"_mail_code"]&&(t.from=e.recommended_by,t.code=e[this.label.fullName()+"_mail_code"]),"transactional"===e.recommended_by&&e[this.label.fullName()+"_mail_code"]&&(t.from="transactional",t.code=e[this.label.fullName()+"_mail_code"]),"transactional_sms"===e.recommended_by&&e[this.label.fullName()+"_transactional_sms_code"]&&(t.from="transactional_sms",t.code=e[this.label.fullName()+"_transactional_sms_code"]),void 0!==t.from?(u.default.set(this.label.fullName()+"_source",JSON.stringify(t),{expires:172800,path:"/"},this),t):null}},{key:"fetchSourceFromStore",value:function(){if(!this.source||void 0===this.source.from){var e=u.default.get(this.label.fullName()+"_source");e&&(e=JSON.parse(e))&&(this.source=e)}}},{key:"fetchRecommendedBy",value:function(e){-1!==["417dfce51c4cc3cc2fe3da5480db10","0fb6cf705ad4c77af1d2740301a950","74fd3b613553b97107bc4502752749"].indexOf(this.shop.token)&&(this.recommendedBy=null,this.recommendedCode=null);var t=e.recommended_by;null!==t&&void 0!==t&&""!==t&&(f.default.isTypeValid(t)?this.recommendedBy=t:this.logger.warn("Preparations: unexpected recommender type: "+t)),(e[this.label.name()+"_search_query"]||e.recommended_code)&&(this.recommendedCode=e[this.label.name()+"_search_query"]||e.recommended_code)}},{key:"trackUTM",value:function(e){var t={};for(var r in e)e.hasOwnProperty(r)&&r.match(/^utm_/i)&&(t[r.toLowerCase()]=e[r]);Object.keys(t).length&&this.push(["utm",t])}},{key:"switchTestMode",value:function(e){var t=this.label.fullName()+"_testmode";e.hasOwnProperty(t)?/(on|true|1)/.test(e[t].toLowerCase())?(this.testMode=!0,u.default.set(t,"true",{path:"/"},this)):(this.testMode=!1,u.default.set(t,"",{expires:-86400,path:"/"},this)):"true"===u.default.get(t)&&(this.testMode=!0),this.testMode&&this.logger.debug("Test mode active")}},{key:"switchNewRecommenderMode",value:function(e){var t=this.label.fullName()+"_test_recommender";e.hasOwnProperty(t)?/(on|true|1)/.test(e[t].toLowerCase())?(this.testRecommenderMode=!0,u.default.set(t,"true",{path:"/"},this)):(this.testRecommenderMode=!1,u.default.set(t,"",{expires:-86400,path:"/"},this)):"true"===u.default.get(t)&&(this.testRecommenderMode=!0),this.testRecommenderMode&&this.logger.debug("Test recommender mode active")}},{key:"addStyleToPage",value:function(e){var t=this.label.fullName()+"-"+e;if(!document.getElementById(t)){var r=document.createElement("link");r.setAttribute("id",t),r.setAttribute("rel","stylesheet"),r.setAttribute("type","text/css"),r.setAttribute("href","//"+this.api.getMasterHost()+"/"+e+"/"+this.shop.token+".css"),document.getElementsByTagName("head")[0].appendChild(r)}}},{key:"addPreConnectedLinkToPage",value:function(e){["dns-prefetch","preconnect"].forEach(function(t){var r=document.createElement("link");r.setAttribute("href","//"+e),r.setAttribute("rel",t),document.head.appendChild(r)})}},{key:"perform",value:function(e){var r=this;switch(void 0===e[0]&&this.logger.warn("Undefined command"),e[0]){case"did":"function"==typeof e[1]&&e[1](this.user.did);break;case"reset_session":this.setSeance(t.guid());break;case"track":this.logger.debug('Track: Track "'+e[1]+'" with data "'+JSON.stringify(e[2])+'"');try{if(-1!==["view","cart","remove_from_cart","category","wish","remove_wish","purchase","recone_click","recone_view","search"].indexOf(e[1]))this.fetchRecommendedBy(t.getUrlVars(this)),new h.default(this,e[1],e[2],e[3]).send(this.recommendedBy,this.source);else if(e[1]){var n=Object.assign(e[2]||{},{shop_id:this.shop.token,did:this.user.did,sid:this.user.seance,event:e[1]});void 0===n.value||Number.isInteger(n.value)?this.ajax.sendPost(this.api.getAPIUrl("/push/custom"),n):this.logger.error("Custom event: value must be an integer")}}catch(e){this.logger.warn(e.message)}break;case"utm":this.logger.debug('Track: UTM with data "'+JSON.stringify(e[1])+'"'),h.default.trackUTM(this,e[1]);break;case"recommend":if(this.logger.debug('Recommender: get "'+e[1]+'" with data "'+JSON.stringify(e[2])+'", "success" as "'+s(e[3])+'", failure as "'+s(e[4])+'" '),"dynamic"===e[1])console.error("Dynamic recommender was deprecated syntax, please use: "+this.label.name()+"('recommend', CODE, params, success, failure)");else if(f.default.getTypes().indexOf(e[1])>=0)return void console.error("Recommender algorithm "+e[1]+" was deprecated, please use dynamic blocks");try{new f.default(this).get(e[2].code||e[1],e[2],e[3],e[4])}catch(e){this.logger.warn(e.message)}break;case"subscription":case"webpush_subscription":case"email_subscription":switch(e[1]){case"web_push_subscribe":this.web_push&&this.web_push.subscribe(!0);break;case"web_push_supported":this.web_push&&"function"==typeof e[2]&&e[2](this.web_push.supported());break;case"web_push_subscribed":this.web_push&&"function"==typeof e[2]&&e[2](this.web_push.isSubscribed());break;case"manage":if(!e[2]||"object"!==s(e[2])||Array.isArray(e[2])||!(e[2]instanceof Object))return this.logger.warn("Subscription Manage: the params shouldn't be empty");this.ajax.sendWithRetry("post",this.api.getAPIUrl("/subscriptions/manage"),Object.assign(e[2],{shop_id:this.shop.token,did:this.user.did,seance:this.user.seance,segment:this.segment||null}))}break;case"subscribe_trigger":new T.default(this).fetch(e[1],e[2]);break;case"unsubscribe_trigger":new T.default(this).fetchUnsubscribe(e[1],e[2]);break;case"check_trigger":new T.default(this).fetchCheck(e[1],e[2],e[3],e[4]);break;case"profile":this.logger.debug('Profile: "'+e[1]+'" with data "'+JSON.stringify(e[2])+'"');try{"set"===e[1]?k.default.set(this,e[2],e[3],e[4]):"get"===e[1]&&k.default.get(this,e[2])}catch(e){this.logger.warn(e.message)}break;case"reputation":this.logger.debug('Reputation: "'+e[1]+'" with data "'+JSON.stringify(e[2])+'", "success" as "'+s(e[3])+'"');try{this.reputation.perform(e[1],e[2],e[3])}catch(e){this.logger.warn(e.message)}break;case"add_css":"recommendations"===e[1]&&this.addStyleToPage("shop_css");break;case"search":if("string"==typeof e[1].search_query&&"function"==typeof e[2]&&this.search){var i={shop_id:this.shop.token,did:this.user.did,type:"full_search",seance:this.user.seance,search_query:e[1].search_query,input_query:e[1].input_query||this.input_query,exact_field_match:this.vars[this.label.name()+"_exact_field_match"]||null,limit:e[1].limit||null,category_limit:e[1].category_limit||null,page:e[1].page||null,offset:e[1].offset||null,brands:e[1].brands?e[1].brands.join(","):null,colors:e[1].colors?e[1].colors.join(","):null,locations:e[1].locations?e[1].locations.join(","):null,price_min:e[1].price_min||null,price_max:e[1].price_max||null,category_names:e[1].category_names?null:e[1].category_names,categories:e[1].categories?e[1].categories.join(","):null,widgetable:void 0!==e[1].widgetable?e[1].widgetable:null,available:void 0!==e[1].available?e[1].available:null,ignored:void 0!==e[1].ignored?e[1].ignored:null,extended:e[1].extended||null,filters:e[1].filters?JSON.stringify(e[1].filters):null,segment:e[1].segment,sort_by:e[1].sort_by||null,order:e[1].order||null,no_clarification:"boolean"==typeof e[1].no_clarification?e[1].no_clarification:null};Object.keys(i).forEach(function(e){return null===i[e]&&delete i[e]});var o=void 0;e[1].search_filters_block&&(o=new Y.default(this,i,e[1].search_filters_block)),this.ajax.sendGet(this.api.getAPIUrl("/search"),i).then(function(t){e[2](t),o&&(o.setCallback(e[2]),o.print(t,!0)),t.popup&&"object"===s(t.popup)&&F.default.prepare(r,t.popup)}).catch(function(t){"function"==typeof e[3]&&e[3](t)})}break;case"suggest":"string"==typeof e[1].search_query&&"function"==typeof e[2]&&this.search&&this.ajax.sendGet(this.api.getAPIUrl("/search"),{shop_id:this.shop.token,did:this.user.did,type:"instant_search",search_query:e[1].search_query,categories:e[1].categories,locations:e[1].locations,subquery:!!e[1].categories,segment:e[1].segment,extended:e[1].extended||null,exact_field_match:this.vars[this.label.name()+"_exact_field_match"]||null}).then(e[2]).catch(function(t){"function"==typeof e[3]&&e[3](t)});break;case"search_collection":e[1].id&&"function"==typeof e[2]&&this.search&&this.ajax.sendGet(this.api.getAPIUrl("/search/collection"),{shop_id:this.shop.token,did:this.user.did,id:e[1].id}).then(e[2]);break;case"search_init":e[1]&&this.search&&U.default.initInstantSearch(this);break;case"full_search_init":U.default.initFullSearch(this);break;case"dynamic_init":f.default.initDynamic(this);break;case"category_init":f.default.initCategory(this);break;case"stories_init":K.default.init(this);break;case"recone":this.logger.debug('RecOne: "'+e[1]+'" with data "'+JSON.stringify(e[2])+'", "success" as "'+s(e[3])+'"'),e[1]&&e[2]&&this.recone.perform(e[1],e[2],e[3]);break;case"say":this.speech&&this.speech.start(e[1]);break;case"get_promo_code":this.logger.debug('Promo code request data: "'+JSON.stringify(e[1])+'", "success" as "'+s(e[2])+'", "error" as "'+s(e[3])+'"'),"function"==typeof e[2]?new A.default(this).get(e[1]).then(function(t){r.promocode=t,e[2](t)}).catch(function(t){"function"==typeof e[3]&&e[3](t)}):this.logger.error('Success Callback should have the type "function", the current type is "'+s(e[2])+'"');break;case"nps":switch(this.logger.debug('NPS request command as "'+e[1]+'", data as "'+JSON.stringify(e[2])+'", "success" as "'+s(e[3])+'", "error" as "'+s(e[4])+'"'),e[1]){case"review":S.default.setReview(this,e[2],e[3],e[4]);break;case"categories":S.default.getCategories(this,e[2],e[3]);break;case"channels":S.default.getChannels(this,e[2],e[3]);break;default:this.logger.warn("NPS: Undefined command: "+e[1])}break;case"segment":switch(this.logger.debug('Segments request command as "'+e[1]+'", data as "'+JSON.stringify(e[2])+'"'),e[1]){case"add":q.default.add(this,e[2]);break;case"remove":q.default.remove(this,e[2]);break;case"get":q.default.get(this,e[2],e[3]);break;default:this.logger.warn("Segments: Undefined command: "+e[1])}break;case"orders":switch(this.logger.debug('Orders request command as "'+e[1]+'", data as "'+JSON.stringify(e[2])+'"'),e[1]){case"last_for_user":P.default.last_for_user(this,e[2],e[3]);break;default:this.logger.warn("Orders: Undefined command: "+e[1])}break;case"products":switch(this.logger.debug('Products request command as "'+e[1]+'", data as "'+JSON.stringify(e[2])+'"'),e[1]){case"counters":Q.default.counters(this,e[2]).then(e[3]||function(){}).catch(e[4]||console.error);break;default:this.logger.warn("Products: Undefined command: "+e[1])}break;case"popup":this.logger.debug('Custom request show popup "'+e[1]+'"'),e[1]&&this.ajax.sendGet(this.api.getAPIUrl("/popup"),{shop_id:this.shop.token,did:this.user.did,sid:this.user.seance,id:e[1]}).then(function(e){return F.default.prepare(r,e)});break;case"debug":this.logger.warn("User: "+JSON.stringify(this.user)),this.logger.warn("Shop: "+JSON.stringify(this.shop)),this.logger.warn("Recommended by: "+JSON.stringify(this.recommendedBy)),this.logger.warn("Source: "+JSON.stringify(this.source));break;default:this.logger.warn("Track: Undefined command: "+e[0])}}},{key:"performCookieQueue",value:function(){try{var e=u.default.get(this.label.name()+"_events_track");if(!e)return;u.default.set(this.label.name()+"_events_track","",{expires:-1,path:"/"},this),e=JSON.parse(e);for(var t in e)e.hasOwnProperty(t)&&this.push(["track",t,e[t]])}catch(e){this.logger.warn("Error parse events cookie: "+e)}}},{key:"performErrorQueue",value:function(){var e=this;Object.keys(localStorage).map(function(t){e.performError(t)})}},{key:"performError",value:function(e){var t=this;if(e.match(RegExp("^"+this.label.fullName()+"_error_.{8}-.{4}-.{4}-.{4}-.{12}$"))&&localStorage.hasOwnProperty(e)){var r=JSON.parse(localStorage.getItem(e));localStorage.removeItem(e),this.ajax.send(r.type,r.url,r.params).catch(function(e,r){return function(n){(0==n.code||n.code>=500)&&++e.attempt<=10&&(e.time=(new Date).getTime(),localStorage.setItem(r,JSON.stringify(e)),t.handleError(r,500*e.attempt))}}(r,e))}}},{key:"handleError",value:function(e,t){var r=this;setTimeout(function(){r.performError(e)},t)}},{key:"pushError",value:function(e,r,n,i){if(0==e.code||e.code>=500){var o=this.label.fullName()+"_error_"+t.guid();localStorage.setItem(o,JSON.stringify({attempt:1,time:(new Date).getTime(),type:r,url:n,params:i})),this.handleError(o,500)}}},{key:"detectPrivateMode",value:function(){var e=this;this.browserIsPrivateMode=!1,"undefined"!=typeof Promise&&new Promise(function(e){var t=void 0,r=function(t){"function"==typeof t.preventDefault&&t.preventDefault(),e(!0)},n=function(){e(!1)};window.webkitRequestFileSystem?webkitRequestFileSystem(0,0,n,r):"MozAppearance"in document.documentElement.style?(t=indexedDB.open("test"),t.onerror=r,t.onsuccess=n):/constructor/i.test(window.HTMLElement)?function(){try{localStorage.length?n():(localStorage.x=1,localStorage.removeItem("x"),n())}catch(e){navigator.cookieEnabled?r():n()}}():window.indexedDB||!window.PointerEvent&&!window.MSPointerEvent?n():r()}).then(function(t){e.browserIsPrivateMode=t,t&&(e.logger.warn("This browser is private mode"),e.webPushSubscription&&(e.webPushSubscription.popupEnabled=!1,e.webPushSubscription.currentUserInfo.showed=!0,e.webPushSubscription.saveUserInfo()))})}},{key:"domOnLoaded",value:function(){this.onLoaded=!1;var e=function(){this.onLoaded||(this.onLoaded=!0,f.default.initDynamic(this),f.default.initCategory(this),U.default.initFullSearch(this),U.default.initInstantSearch(this))}.bind(this);"complete"!=document.readyState&&(document.addEventListener?(document.addEventListener("DOMContentLoaded",e),window.addEventListener("load",e)):window.attachEvent&&window.attachEvent("onload",e))}},{key:"email_collector",value:function(){var e=this;if(this.shop.email_collector)var r=["login","mail","user","name"],n=setInterval(function(){var i=[document];[].forEach.call(document.getElementsByTagName("iframe"),function(e){e.hasAttribute("src")&&e.src.length>0&&RegExp("^"+document.location.origin,"i").test(e.src)&&e.contentDocument&&i.push(e.contentDocument)}),[].forEach.call(i,function(i){var o=i.getElementsByTagName("input");[].forEach.call(o,function(i){if(!(i.classList.contains(e.label.fullName()+"-initialized")||i.getAttribute("type")&&"hidden"===i.type.toLowerCase())){var o=i.attributes;o.length>0&&[].some.call(o,function(o){var a=o.value;return r.some(function(r){return!!(a.toLowerCase().indexOf(r)+1)&&(i.classList.add(e.label.fullName()+"-initialized"),i.addEventListener("blur",function(){var r=i.value.trim().toLowerCase();if(t.validEmail(r)&&e.collectedEmail!==r){var o=RegExp("^.+(@|\\.)"+e.label.fullName()+"\\.com$","i");if(!t.isHiddenTag(i)&&!o.test(r)&&!o.test(location.host)||e.logger.debugLevel){clearInterval(n),e.collectedEmail=r;var a={shop_id:e.shop.token,did:e.user.did,email:r};e.ajax.sendWithRetry("post",e.api.getAPIUrl("/subscriptions/collector"),a)}}}),!0)})})}})})},300)}},{key:"isSafari",value:function(){return/constructor/i.test(window.HTMLElement)||function(e){return""+e=="[object SafariRemoteNotification]"}(!window.safari||"undefined"!=typeof safari&&window.safari.pushNotification)}}],[{key:"getUrlVars",value:function(e){for(var t=window.location.search.substring(1).split("&"),r={},n=0;n<t.length;n++){var i=t[n].split("=");try{void 0===r[i[0]]?r[i[0]]=decodeURIComponent(i[1]):"string"==typeof r[i[0]]?r[i[0]]=[r[i[0]],decodeURIComponent(i[1])]:r[i[0]].push(decodeURIComponent(i[1]))}catch(r){e.logger.debug("Incorrect input value for decode: "+t[n])}}return r}},{key:"isBot",value:function(e){var r=/Vercelbot|YandexMetrika|YaDirectFetcher|YandexAccessibilityBot|YandexAdNet|YandexBlogs|YandexCalendar|YandexDialogs|YandexDirect|YandexFavicons|YandexForDomain|YandexImages|YandexImageResizer|YandexMobileBot|YandexMobileScreenShotBot|YandexMarket|YandexNews|YandexOntoDB|YandexPagechecker|YandexPartner|YandexRCA|YandexRenderResourcesBot|YandexSearchShop|YandexSitelinks|YandexSpravBot|YandexTracker|YandexTurbo|YandexUserproxy|YandexVertis|YandexVerticals|YandexVideo|YandexScreenshotBot|Googlebot|AdsBot|BingPreview|bingbot|Screenshot Bot|YandexAntivirus|PEBOT|Googlebot-Mobile|Googlebot-Image|Google favicon|Mediapartners-Google|slurp|java|wget|curl|Commons-HttpClient|Python-urllib|libwww|httpunit|nutch|phpcrawl|msnbot|jyxobot|FAST-WebCrawler|FAST Enterprise Crawler|biglotron|teoma|convera|seekbot|gigablast|exabot|ngbot|ia_archiver|GingerCrawler|webmon |httrack|webcrawler|grub.org|UsineNouvelleCrawler|antibot|netresearchserver|speedy|fluffy|bibnum.bnf|findlink|msrbot|panscient|yacybot|AISearchBot|IOI|ips-agent|tagoobot|MJ12bot|dotbot|woriobot|yanga|buzzbot|mlbot|yandexbot|purebot|Linguee Bot|Voyager|CyberPatrol|voilabot|baiduspider|citeseerxbot|spbot|twengabot|postrank|turnitinbot|scribdbot|page2rss|sitebot|linkdex|Adidxbot|blekkobot|ezooms|Mail.RU_Bot|discobot|heritrix|findthatfile|europarchive.org|NerdByNature.Bot|sistrix crawler|ahrefsbot|Aboundex|domaincrawler|wbsearchbot|summify|ccbot|edisterbot|seznambot|ec2linkfinder|gslfbot|aihitbot|intelium_bot|facebookexternalhit|yeti|RetrevoPageAnalyzer|lb-spider|sogou|lssbot|careerbot|wotbox|wocbot|ichiro|DuckDuckBot|lssrocketcrawler|drupact|webcompanycrawler|acoonbot|openindexspider|gnam gnam spider|web-archive-net.com.bot|backlinkcrawler|coccoc|integromedb|content crawler spider|toplistbot|seokicks-robot|it2media-domain-crawler|ip-web-crawler.com|siteexplorer.info|elisabot|proximic|changedetection|blexbot|arabot|WeSEE:Search|niki-bot|CrystalSemanticsBot|rogerbot|360Spider|psbot|InterfaxScanBot|Lipperhey SEO Service|CC Metadata Scaper|g00g1e.net|GrapeshotCrawler|urlappendbot|brainobot|fr-crawler|binlar|SimpleCrawler|Livelapbot|cXensebot|smtbot|bnf.fr_bot|A6-Indexer|ADmantX|Facebot|Twitterbot|OrangeBot|memorybot|AdvBot|MegaIndex|SemanticScholarBot|ltx71|nerdybot|xovibot|BUbiNG|Qwantify|archive.org_bot|Applebot|TweetmemeBot|crawler4j|findxbot|SemrushBot|yoozBot|lipperhey|y!j-asr|Domain Re-Animator Bot|AddThis|BitSightBot/i;return null!==navigator.userAgent.match(r)||!RegExp("^demo."+e.label.name(),"i").test(document.location.hostname)&&t.isBrowserEmulator(e)}},{key:"isBrowserEmulator",value:function(e){e.logger.debug("navigator.plugins:               "+(navigator.plugins instanceof PluginArray)),e.logger.debug("!Function.prototype.bind:        "+!Function.prototype.bind),e.logger.debug("window.Buffer:                   "+window.Buffer),e.logger.debug("window.webdriver:                "+window.webdriver),e.logger.debug("window.domAutomation:            "+window.domAutomation),e.logger.debug("window.domAutomationController:  "+window.domAutomationController),e.logger.debug("window.navigator.onLine:         "+window.navigator.onLine);var t=navigator.plugins instanceof PluginArray==!1||window.callPhantom||window._phantom||!Function.prototype.bind||window.Buffer&&!window.r46_buffer||window.emit||window.spawn||window.webdriver||window.domAutomation||window.domAutomationController||!1===window.navigator.onLine,r={};try{null[0]()}catch(e){r=e}return t||r.stack&&"string"==typeof r.stack&&r.stack.indexOf("phantom")>=0}},{key:"isMobile",value:function(){var e=!1;return function(t){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(t)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(t.substr(0,4)))&&(e=!0)}(navigator.userAgent||navigator.vendor||window.opera),e}},{key:"corsAvailable",value:function(){return!(document.all&&!document.querySelector)}},{key:"validEmail",value:function(e){return-1!==e.indexOf("@")&&/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(e)}},{key:"isHiddenTag",value:function(e){var t=window.getComputedStyle?getComputedStyle(e,""):e.currentStyle;return void 0!==t.display&&"none"===t.display}},{key:"guid",value:function(){var e=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}},{key:"eventPassiveSupported",value:function(){var e=!1;try{var t=Object.defineProperty({},"passive",{get:function(){e=!0}});window.addEventListener("test",null,t),window.removeEventListener("test",null,t)}catch(e){}return e}},{key:"addEvent",value:function(e,r,n){e.addEventListener?e.addEventListener(r,n,!!t.eventPassiveSupported()&&{passive:!1}):e.attachEvent&&e.attachEvent("on"+r,n)}},{key:"dispatchEvent",value:function(e,t){var r=void 0;document.createEvent?(r=document.createEvent("HTMLEvents"),r.initEvent(t,!0,!0)):(r=document.createEventObject(),r.eventType=t),r.eventName=t,document.createEvent?e.dispatchEvent(r):e.fireEvent("on"+r.eventType,r)}},{key:"serializeToURLEncodedParams",value:function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=[];if(Object.keys(e).length>0)for(var i in e){var o=r?r+"["+i+"]":i,a=e[i];n.push(null!==a&&"object"===(void 0===a?"undefined":s(a))?t.serializeToURLEncodedParams(a,o):encodeURIComponent(o)+"="+encodeURIComponent(a))}else r&&n.push(encodeURIComponent(r)+"=");return n.join("&")}},{key:"serializeToObject",value:function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n={};if(Object.keys(e).length>0)for(var i in e){var o=r?r+"["+i+"]":i,a=e[i];null!==a&&"object"===(void 0===a?"undefined":s(a))?n=Object.assign(n,t.serializeToObject(a,o)):n[o]=a}else r&&(n[r]="");return n}}]),t}(I.default);t.default=Z},function(e,t,r){"use strict";function n(){}function i(e){try{return e.then}catch(e){return b=e,v}}function o(e,t){try{return e(t)}catch(e){return b=e,v}}function a(e,t,r){try{e(t,r)}catch(e){return b=e,v}}function s(e){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("Promise constructor's argument is not a function");this._40=0,this._65=0,this._55=null,this._72=null,e!==n&&m(e,this)}function c(e,t,r){return new e.constructor(function(i,o){var a=new s(n);a.then(i,o),l(e,new f(t,r,a))})}function l(e,t){for(;3===e._65;)e=e._55;if(s._37&&s._37(e),0===e._65)return 0===e._40?(e._40=1,void(e._72=t)):1===e._40?(e._40=2,void(e._72=[e._72,t])):void e._72.push(t);u(e,t)}function u(e,t){g(function(){var r=1===e._65?t.onFulfilled:t.onRejected;if(null===r)return void(1===e._65?d(t.promise,e._55):h(t.promise,e._55));var n=o(r,e._55);n===v?h(t.promise,b):d(t.promise,n)})}function d(e,t){if(t===e)return h(e,new TypeError("A promise cannot be resolved with itself."));if(t&&("object"==typeof t||"function"==typeof t)){var r=i(t);if(r===v)return h(e,b);if(r===e.then&&t instanceof s)return e._65=3,e._55=t,void p(e);if("function"==typeof r)return void m(r.bind(t),e)}e._65=1,e._55=t,p(e)}function h(e,t){e._65=2,e._55=t,s._87&&s._87(e,t),p(e)}function p(e){if(1===e._40&&(l(e,e._72),e._72=null),2===e._40){for(var t=0;t<e._72.length;t++)l(e,e._72[t]);e._72=null}}function f(e,t,r){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.promise=r}function m(e,t){var r=!1,n=a(e,function(e){r||(r=!0,d(t,e))},function(e){r||(r=!0,h(t,e))});r||n!==v||(r=!0,h(t,b))}var g=r(6),b=null,v={};e.exports=s,s._37=null,s._87=null,s._61=n,s.prototype.then=function(e,t){if(this.constructor!==s)return c(this,e,t);var r=new s(n);return l(this,new f(e,t,r)),r}},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(4),s=n(a),c=r(1),l=n(c),u=r(0),d=n(u),h=function(){function e(t,r){var n=this;i(this,e),this.core=t,this.data=r;var o=e.popupName(r.id);if(this.name=o,this.addStyleToPage(r.id),0===r.channels.length||1===r.channels.length&&("web_push"===r.channels[0]&&t.web_push&&t.web_push.supported()||"web_push"!==r.channels[0])||r.channels.length>1)if(document.body.insertAdjacentElement)try{setTimeout(function(){if("showed"!==d.default.get(n.core.label.name()+"-popup-"+r.id)){if(1===r.channels.length&&"web_push"===r.channels[0]&&r.web_push_system)n.subscribe();else{if(document.getElementById(o))return void n.core.logger.debug("Popup "+o+" already showed");n.dialog=document.createElement("div"),n.dialog.id=o,n.dialog.innerHTML=r.html,document.body.insertAdjacentElement("beforeEnd",n.dialog),"top"===r.position&&n.dialog.childNodes[0].classList.add(o+"_top"),-1!==["slide_right","slide_left","fixed_bottom"].indexOf(r.position)&&(n.dialog.childNodes[0].classList.add(o+"_bottom"),"slide_right"===r.position&&n.dialog.childNodes[0].classList.add(o+"_right"),"slide_left"===r.position&&n.dialog.childNodes[0].classList.add(o+"_left")),n.modal=document.getElementById(o+"-modal"),n.closeButton=document.getElementById(o+"-close"),n.form=document.getElementById(o+"-form"),n.submitButton=document.getElementById(o+"-submit"),n.select=document.getElementById(o+"-subscription-type"),n.email=document.getElementById(o+"-email"),n.dialog.onclick=n.close.bind(n),n.modal.onclick=function(e){e.stopPropagation()},n.closeButton.onclick=n.close.bind(n);var e=function e(t){t=t||window.event,27===t.keyCode&&(n.close(),document.removeEventListener("keydown",e))};document.addEventListener("keydown",e),n.submitButton&&(n.submitButton.onclick=n.submit.bind(n)),n.form&&(n.form.onsubmit=n.submit.bind(n)),n.select&&n.email&&l.default.addEvent(n.select,"change",function(e){n.email.classList.toggle(o+"__hidden","web_push"===n.select.value)})}n.showed();var t=n.core.label.name()+"_popup_callback";"function"==typeof window[t]&&window[t](n.dialog)}},1e3*r.delay)}catch(e){this.core.logger.error(e.message+": "+e.stack,this)}else this.core.logger.error("Old browser");else this.core.logger.error("Web push subscription not supported in the current browser")}return o(e,[{key:"close",value:function(){var e=this;clearTimeout(this.closeTimer),this.dialog.className=this.dialog.className+" "+this.name+"_removed",setTimeout(function(){e.dialog.parentNode.removeChild(e.dialog)},300)}},{key:"submit",value:function(e){e.preventDefault(),e.stopPropagation(),(this.select&&(-1!==["all","email"].indexOf(this.select.value)&&this.formValid(e)||-1===["all","email"].indexOf(this.select.value))||!this.select&&("web_push"===this.data.channels[0]||"email"===this.data.channels[0]&&this.formValid(e)))&&this.submitSuccess()}},{key:"submitSuccess",value:function(){this.dialog.firstChild.classList.add(this.name+"_successfully");var e=this.data.channels;this.data.channels.length>1&&(e=this.select&&"all"!==this.select.value?[this.select.value]:this.data.channels),this.subscribe(e)}},{key:"subscribe",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r={popup:this.data.id};if(this.email&&(r.email=this.email.value),!this.data.web_push_system)for(var n=["first_name","last_name","phone","birthday"],i=0;i<4;i++){var o=n[i],a=this.dialog.querySelector('input[name="'+o+'"]');a&&a.value&&(r[o]=a.value.substr(0,250))}null!==t&&-1===t.indexOf("web_push")||!this.core.web_push?s.default.set(this.core,r):this.core.web_push.subscribe(!0,!0).then(function(t){t&&s.default.set(e.core,Object.assign(r,{web_push_token:t}),function(){return e.core.logger.debug("Пользователь успешно подписался",e)})}).catch(function(t){s.default.set(e.core,r),e.core.logger.error("The user has rejected the web push subscription request or is using a browser mode in which subscription isn't possible (incognito, private, etc). Error: "+t,e)})}},{key:"formValid",value:function(e){var t=this.form.querySelector("input:invalid");return t?(t.focus(),!1):this.form.checkValidity()}},{key:"showed",value:function(){var e={shop_id:this.core.shop.token,did:this.core.user.did,seance:this.core.user.seance,sid:this.core.user.seance,popup:this.data.id};this.core.ajax.sendWithRetry("post",this.core.api.getAPIUrl("/popup/showed"),e),"true"!==d.default.get(this.core.label.name()+"_testmode")&&d.default.set(this.core.label.name()+"-popup-"+this.data.id,"showed",{expires:60,path:"/"},this.core)}},{key:"addStyleToPage",value:function(e){var t=this.core.label.fullName()+"-popup-css-"+e;if(!document.getElementById(t)){var r=document.createElement("link");r.setAttribute("id",t),r.setAttribute("rel","stylesheet"),r.setAttribute("type","text/css"),r.setAttribute("href","//"+this.core.api.getMasterHost()+"/popup_css/"+this.core.shop.token+"_popup_"+e+".css"),document.getElementsByTagName("head")[0].appendChild(r)}}}],[{key:"prepare",value:function(t,r){r.id&&r.html&&!document.getElementById(this.popupName(r.id))&&new e(t,r)}},{key:"popupName",value:function(e){return"popup-"+e}}]),e}();t.default=h},function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(1),s=function(e){return e&&e.__esModule?e:{default:e}}(a),c=function(){function e(){n(this,e)}return o(e,null,[{key:"set",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if("object"===(void 0===t?"undefined":i(t))&&!s.default.isBot(e)){var o=t;t.hasOwnProperty("location")&&(e.user.location=t.location),t.hasOwnProperty("birthday")&&!t.birthday.match(/^\d{4}-\d{2}-\d{2}$/)&&delete o.birthday,Object.keys(o).length>0&&(o.shop_id=e.shop.token,o.seance=e.user.seance,o.did=e.user.did,e.ajax.sendPost(e.api.getAPIUrl("/profile/set"),o).then(r).catch(function(e){if(!n)throw Error(e);n(e)}))}}},{key:"get",value:function(e,t){if("function"!=typeof t)throw Error("Incorrect callback function");e.user.profile?t(e.user.profile):e.ajax.sendGet(e.api.getAPIUrl("/profile"),{did:e.user.did,shop_id:e.shop.token}).then(function(r){e.user.profile=r,t(r)})}}]),e}();t.default=c},function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(1),a=function(e){return e&&e.__esModule?e:{default:e}}(o),s=function(){function e(t,r,i,o){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};n(this,e),this.core=t,this.params=r,this.block=i,this.selected=a,this.categories_selected=r.categories?r.categories.split(","):[],this.brands_selected=r.brands?r.brands.split(","):[],this.url_params=new URLSearchParams(window.location.search),this.endpoint=o}return i(e,[{key:"setCallback",value:function(e){this.callback=e}},{key:"setTotalResultSelector",value:function(e){this.total=e}},{key:"setSortSelector",value:function(e){this.sort=e}},{key:"request",value:function(){var e=this,t=Object.assign({},this.params);if(this.categories_selected=[],[].forEach.call(this.findRoot().querySelectorAll("#"+this.core.label.fullName()+"_search_categories input:checked"),function(t){e.categories_selected.push(t.value)}),t.categories=this.categories_selected.join(","),this.url_params.set(this.core.label.fullName()+"_search_categories",t.categories),this.brands_selected=[],[].forEach.call(this.findRoot().querySelectorAll("#"+this.core.label.fullName()+"_search_brands input:checked"),function(t){e.brands_selected.push(t.value)}),t.brands=this.brands_selected.join(","),this.url_params.set(this.core.label.fullName()+"_search_brands",t.brands),this.selected={},[].forEach.call(this.findRoot().querySelectorAll("#"+this.core.label.fullName()+"_search_filters input:checked"),function(t){var r=t.parentElement.parentElement.getAttribute("data-name");e.selected[r]||(e.selected[r]=[]),e.selected[r].push(t.value)}),t.filters=JSON.stringify(this.selected),this.url_params.set(this.core.label.fullName()+"_search_filters",t.filters),this.sort){var r=document.querySelector(this.sort);t.sort_by=r.value.split("_")[0],t.order=r.value.split("_")[1],this.url_params.set(this.core.label.fullName()+"_search_sort_by",t.sort_by),this.url_params.set(this.core.label.fullName()+"_search_order",t.order||"")}history.replaceState("","",window.location.pathname+"?"+this.url_params),this.core.ajax.sendGet(this.core.api.getAPIUrl(this.endpoint),t).then(function(t){e.callback(t),e.print(t)})}},{key:"print",value:function(e){var t=this;arguments.length>1&&void 0!==arguments[1]&&arguments[1]&&(this.filters=e.filters||{},this.categories=e.categories||[],this.brands=e.brands||[],this.html(),this.sort&&a.default.addEvent(document.querySelector(this.sort),"change",this.request.bind(this)));for(var r in this.filters)!function(r){if(t.filters.hasOwnProperty(r)){var n="#"+t.core.label.fullName()+'_search_filters > div[data-name="'+CSS.escape(r)+'"]';for(var i in t.filters[r].values)[].forEach.call(t.findRoot().querySelectorAll(n+" label"),function(n){var i=n.getAttribute("data-name"),o=n.querySelector("input");o.disabled=(!e.filters[r]||e.filters[r]&&!e.filters[r].values[i])&&!t.selected[r],o.checked=t.selected[r]&&-1!==t.selected[r].indexOf(i),n.querySelector("div").setAttribute("data-sup",e.filters[r]&&e.filters[r].values[i]||"")})}}(r);[].forEach.call(this.findRoot().querySelectorAll("#"+this.core.label.fullName()+"_search_categories label"),function(r){var n=r.querySelector("input"),i=r.getAttribute("data-name");n.disabled=!e.categories.filter(function(e){return i===e.id}).length&&0===t.categories_selected.length,n.checked=-1!==t.categories_selected.indexOf(i)}),[].forEach.call(this.findRoot().querySelectorAll("#"+this.core.label.fullName()+"_search_brands label"),function(r){var n=r.querySelector("input"),i=r.getAttribute("data-name");n.disabled=!e.brands.filter(function(e){return i===e.name.toLowerCase()}).length&&0===t.brands_selected.length,n.checked=-1!==t.brands_selected.indexOf(i)}),this.total&&(document.querySelector(this.total).textContent=e.products_total)}},{key:"findRoot",value:function(){return document.querySelector(this.block)}},{key:"html",value:function(){var e=this.findRoot();if(e){if(this.categories.length){this.core.logger.debug("Filters print "+this.categories.length+" categories"),e.appendChild(this._createElement("div",[this.core.label.fullName()+"-search-group-title",this.core.label.fullName()+"-search-group-title-categories"],e.getAttribute("data-categories-title")||this.core.search&&this.core.search.settings.categories_title||"Категории"));var t=document.createElement("div");t.id=this.core.label.fullName()+"_search_categories",e.appendChild(t);var r=!0,n=!1,i=void 0;try{for(var o,s=this.categories[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var c=o.value,l=this._createCheckbox(c.id,c.name,c.count);a.default.addEvent(l.querySelector("input"),"change",this.request.bind(this)),t.appendChild(l)}}catch(e){n=!0,i=e}finally{try{!r&&s.return&&s.return()}finally{if(n)throw i}}}if(this.brands.length){this.core.logger.debug("Filters print "+this.brands.length+" brands"),e.appendChild(this._createElement("div",[this.core.label.fullName()+"-search-group-title",this.core.label.fullName()+"-search-group-title-brands"],e.getAttribute("data-brands-title")||this.core.search&&this.core.search.settings.brands_title||"Бренды"));var u=document.createElement("div");u.id=this.core.label.fullName()+"_search_brands",e.appendChild(u);var d=!0,h=!1,p=void 0;try{for(var f,m=this.brands[Symbol.iterator]();!(d=(f=m.next()).done);d=!0){var g=f.value,b=this._createCheckbox(g.name.toLowerCase(),g.name);a.default.addEvent(b.querySelector("input"),"change",this.request.bind(this)),u.appendChild(b)}}catch(e){h=!0,p=e}finally{try{!d&&m.return&&m.return()}finally{if(h)throw p}}}if(Object.keys(this.filters).length){this.core.logger.debug("Filters print "+Object.keys(this.filters).length+" filters"),e.appendChild(this._createElement("div",[this.core.label.fullName()+"-search-group-title",this.core.label.fullName()+"-search-group-title-filters"],e.getAttribute("data-filters-title")||this.core.search&&this.core.search.settings.filters_title||"Фильтры"));var v=document.createElement("div");v.id=this.core.label.fullName()+"_search_filters",e.appendChild(v);for(var y in this.filters)this.filters.hasOwnProperty(y)&&v.appendChild(this._createFilter(y,this.filters[y]))}this.core.logger.debug("Filters block html: "+e.innerHTML)}else this.core.logger.warn("Filter block "+this.block+" not found")}},{key:"_createElement",value:function(e,t,r){var n=document.createElement(e);return t&&(Array.isArray(t)?t.forEach(function(e){return n.classList.add(e)}):n.classList.add(t)),n.textContent=r,n}},{key:"_createCheckbox",value:function(e,t,r){var n=document.createElement("label");n.classList.add(this.core.label.fullName()+"-search__checkbox"),n.setAttribute("data-name",e);var i=document.createElement("input");i.setAttribute("type","checkbox"),i.value=e,n.appendChild(i),n.appendChild(document.createElement("span"));var o=this._createElement("div",null,t||e);return o.setAttribute("data-sup",r||""),n.appendChild(o),n}},{key:"_createFilter",value:function(e,t){var r=document.createElement("div");r.setAttribute("data-name",e),r.appendChild(this._createElement("div",this.core.label.fullName()+"-search-filter",e));for(var n in t.values){var i=this._createCheckbox(n,null,t.values[n]);a.default.addEvent(i.querySelector("input"),"change",this.request.bind(this)),r.appendChild(i)}return r}}]),e}();t.default=s},function(e,t,r){"use strict";(function(t){function r(e){a.length||(o(),s=!0),a[a.length]=e}function n(){for(;c<a.length;){var e=c;if(c+=1,a[e].call(),c>l){for(var t=0,r=a.length-c;t<r;t++)a[t]=a[t+c];a.length-=c,c=0}}a.length=0,c=0,s=!1}function i(e){return function(){function t(){clearTimeout(r),clearInterval(n),e()}var r=setTimeout(t,0),n=setInterval(t,50)}}e.exports=r;var o,a=[],s=!1,c=0,l=1024,u=void 0!==t?t:self,d=u.MutationObserver||u.WebKitMutationObserver;o="function"==typeof d?function(e){var t=1,r=new d(e),n=document.createTextNode("");return r.observe(n,{characterData:!0}),function(){t=-t,n.data=t}}(n):i(n),r.requestFlush=o,r.makeRequestCallFromTimer=i}).call(t,r(10))},function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=function(){function e(t){n(this,e),this.debugLevel=t.debug||!1,this.label=t.label}return i(e,[{key:"debug",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.debugLevel&&this._print(this.label.fullName().toUpperCase()+" debug: "+(t?t.constructor.name+": ":"")+e)}},{key:"warn",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this._print(this.label.fullName().toUpperCase()+" warning: "+(t?t.constructor.name+": ":"")+e,!0)}},{key:"error",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this._print(this.label.fullName().toUpperCase()+" error: "+(t?t.constructor.name+": ":"")+e)}},{key:"_print",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];void 0!==console.log?console.log(e):!0!==t&&alert(e)}}],[{key:"isDebug",value:function(){var e=!1,t=new Image;if(t.__defineGetter__("id",function(){e=!0}),console&&(console.log(t),console.clear()),void 0===console.profile)return!1;console.profile(),console.profileEnd(),console.clear&&console.clear();try{chrome.tabs.query({url:"chrome-devtools://*/*"},function(t){t.length>0&&(e=!0)})}catch(e){}var r=new Date,n=new Date;return!0===e||console.profile.length>0||n-r>100}}]),e}();t.default=o},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(0),c=n(s),l=r(5),u=n(l),d=r(3),h=(n(d),function(){function e(t){i(this,e),this.core=t}return a(e,[{key:"get",value:function(e,t,r,n){if(!this.core.shop.recommendations)return"recommendations disabled";this.type="dynamic",this.params=t||{},this.code=e,this.code&&(this.code=this.code.toLowerCase()),this.success=r,this.failure=n,this.validate();var i={shop_id:this.core.shop.token,did:this.core.user.did,seance:c.default.get(this.core.label.fullName()+"_session_code")||null};i.segment=this.core.segment,this.params.price_sensitive&&(i.price_sensitive=this.params.price_sensitive),this.params.cart&&(i["cart_item_id[]"]=[],this.params.cart.forEach(function(e){i["cart_item_id[]"].push(e)})),this.params.locations&&(i.locations=this.params.locations.join(",")),this.params.extended&&(i.extended=1),this.params.discount&&(i.discount=1),this.params.search_query&&(i.search_query=this.params.search_query),this.params.category&&(i.category=this.params.category),this.params.categories&&(i.categories=this.params.categories.join(",")),this.params.exclude&&(i.exclude=this.params.exclude.join(",")),this.params.item&&(i.item_id=this.params.item),this.params.limit&&(i.limit=this.params.limit),this.params.brands&&(i.brands=this.params.brands.join(",")),this.params.exclude_brands&&(i.exclude_brands=this.params.exclude_brands.join(",")),this.params.items&&(i.items=this.params.items.join(",")),this.params.prevent_shuffle&&(i.prevent_shuffle=1),this.params.page&&this.params.page>1&&(i.page=this.params.page),this.core.ajax.sendGet(this.core.api.getAPIUrl((this.core.testRecommenderMode?"/test":"")+"/recommend/"+this.code),i).then(r).catch(function(e){if(!n)throw Error(e);n(e)})}},{key:"validate",value:function(){if(!e.isTypeValid(this.type))throw Error('Recommender: invalid type "'+this.type+'"');if("dynamic"===this.type&&!this.code)throw Error("Recommender: invalid code of block");if(void 0===this.params||null===this.params)throw Error("Recommender: params not set");if("function"!=typeof this.success)throw Error('Recommender: success callback must be function, got "'+o(this.success)+'"');if(this.failure&&"function"!=typeof this.failure)throw Error('Recommender: failure callback must be function or undefined, got "'+o(this.failure)+'"');if(this.params.cart){if(!(this.params.cart instanceof Array))throw Error("Recommender: incorrect cart syntax, must be array");0===this.params.cart.length&&(this.params.cart=null)}if(this.params.locations){if(!(this.params.locations instanceof Array))throw Error("Recommender: incorrect locations syntax, must be array");0===this.params.locations.length&&(this.params.locations=null)}if(this.params.categories){if(!(this.params.categories instanceof Array))throw Error("Recommender: incorrect categories syntax, must be array");0===this.params.categories.length&&(this.params.categories=null)}if(this.params.brands){if(!(this.params.brands instanceof Array))throw Error("Recommender: incorrect brands syntax, must be array");0===this.params.brands.length&&(this.params.brands=null)}if(this.params.exclude_brands){if(!(this.params.exclude_brands instanceof Array))throw Error("Recommender: incorrect exclude_brands syntax, must be array");0===this.params.exclude_brands.length&&(this.params.exclude_brands=null)}switch(this.type){case"search":if(!this.params.search_query)throw Error("Recommender: search query is not set for search recommender");break;case"see_also":if(!this.params.cart)throw Error('Recommender: cart is empty, recommender "see_also" doesn\'t work without cart')}return!0}}],[{key:"isTypeValid",value:function(t){return e.getTypes().indexOf(t)>=0}},{key:"getTypes",value:function(){return["dynamic","category","interesting","also_bought","popular","similar","recently_viewed","also_viewed","see_also","buying_now","supply","trigger_mail","digest_mail","search","web_push_digest","web_push_trigger","instant_search","full_search","sponsored","next_best_offer","novelties","profitable","cluster_number","cluster_items","reputation","popup","transactional","stories"]}},{key:"initDynamic",value:function(t){if(t.shop.token&&t.user.did&&t.shop.recommendations){var r=!1,n=null,i=function(r){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!n||!r.classList.contains(t.label.fullName()+"-recommend-rendered")&&i.intersectionRatio&&0!==i.intersectionRatio){r.classList.add(t.label.fullName()+"-recommend-rendered");var o={};["code","item","category","search_query","for_user","min","limit","page"].forEach(function(e){var t=r.getAttribute("data-recommender-"+e);t&&(o[e]=t.replace(/^\s+|\s+$/g,""),"code"===e&&(o[e]=o[e].toLowerCase()))}),["brands","categories","exclude","locations","items"].forEach(function(e){var t=r.getAttribute("data-recommender-"+e);t&&(o[e]=t.split(/,/).reduce(function(e,t){return t.length>0&&e.push(t.trim()),e},[]))});var a=function(e,r){if(void 0!==r.html)e.innerHTML=r.html;else{if("paused"===r.state)return;t.logger.error("Recommender template can not be blank for: "+e.getAttribute("data-recommender-code"))}var n=e.getAttribute("data-recommender-callback");n&&(void 0===window[n]?console.error("Global function "+n+" is not defined"):window[n](e,r)),r.snippet&&Function(r.snippet)(e,r)};s++,s>=l&&(c++,s=0),setTimeout(function(){new e(t).get(o.code,o,function(e){if(e.recommends&&o.min&&e.recommends.length<o.min)return void t.logger.debug("There are fewer products in the API response than necessary. Necessary: "+o.min+", the API response: "+e.recommends.length);if(document.contains(r))a(r,e);else{t.logger.debug("Trying to find the block again by its code if its pointer was lost.");var n=r.getAttribute("data-recommender-code");n&&[].forEach.call(document.querySelectorAll("."+t.label.fullName()+'-recommend[data-recommender-code="'+n+'"]'),function(t){a(t,e)})}},function(){var e=r.getAttribute("data-recommender-error");document.contains(r)&&e&&(void 0===window[e]?console.error("Global function "+e+" is not defined"):window[e](r))})},n?0:200*c)}};if(t.shop.recommendersLazyLoad&&!t.isSafari()&&"IntersectionObserver"in window&&"IntersectionObserverEntry"in window&&"intersectionRatio"in window.IntersectionObserverEntry.prototype){r=!0;var o={root:null},a=function(e){e.forEach(function(e){return e.target&&i(e.target,r,e)})};n=new IntersectionObserver(a,o)}var s=0,c=0,l=5;Array.from(document.querySelectorAll("."+t.label.fullName()+'-recommend[data-recommender-block="dynamic"]:not(.'+t.label.fullName()+"-recommend-rendered)")).sort(function(e,t){var r=getComputedStyle(e),n=getComputedStyle(t);return(null!==t.offsetParent&&"none"!==n.display&&"hidden"!==n.visible)-(null!==e.offsetParent&&"none"!==r.display&&"hidden"!==r.visible)}).forEach(function(e){r?n.observe(e):i(e,r)})}}},{key:"initCategory",value:function(e){if(e.shop.token&&e.user.did&&e.shop.recommendations){var t=document.querySelectorAll("."+e.label.fullName()+"-category-results:not(."+e.label.fullName()+"-category-results-rendered)");if(0===t.length)return;e.addStyleToPage("search_css"),[].forEach.call(t,function(t,r){t.classList.add(e.label.fullName()+"-category-results-rendered");var n=t.getAttribute("data-category"),i=void 0;if(n){var o={shop_id:e.shop.token,did:e.user.did,seance:e.user.seance};if(["limit","page","offset","available","sort-by","order","filters","locations","price-min","price-max","brands"].forEach(function(e){var r=t.getAttribute("data-category-"+e);r&&(o[e.replace("-","_")]=r.replace(/^\s+|\s+$/g,""))}),t.getAttribute("data-category-filters-block")&&document.querySelector(t.getAttribute("data-category-filters-block"))){var a={};try{a=JSON.parse(t.getAttribute("data-category-filters")||"{}")}catch(t){e.logger.error(t)}i=new u.default(e,o,t.getAttribute("data-category-filters-block"),"/category/"+n,a),i.setTotalResultSelector(t.getAttribute("data-category-total-block")),i.setSortSelector(t.getAttribute("data-category-sort-block"))}else e.logger.debug("Category filter block: "+t.getAttribute("data-category-filters-block")+", found: "+!!document.querySelector(t.getAttribute("data-category-filters-block")));var s=function(t,r){var n=function(r){void 0!==r.html?t.innerHTML=r.html:e.logger.error("Category template is missing."),void 0!==r.products_total&&t.setAttribute("data-category-response-total",r.products_total);var n=t.getAttribute("data-category-callback");n&&(void 0===window[n]?console.error("Global function "+n+" is not defined"):window[n](t,r))};if(e.logger.debug("Category attach results"),n(r),e.logger.debug("Category filters object: "+i),i){i.setCallback(n);try{i.print(r,!0)}catch(t){e.logger.error(t)}}};e.logger.debug("Category request with data "+JSON.stringify(o)),e.ajax.sendGet(e.api.getAPIUrl("/category/"+n),o).then(function(n){if(document.contains(t))s(t,n);else{e.logger.debug("Trying to find the category block again by its index if its pointer was lost.");var i=document.querySelectorAll("."+e.label.fullName()+"-category-results");void 0!==r&&void 0!==i[r]&&s(i[r],n)}}).catch(function(e){var r=t.getAttribute("data-category-error");r&&(void 0===window[r]?console.error("Global function "+r+" is not defined"):window[r](t))})}else e.logger.error("Category can not be blank for div implementation")})}}}]),e}());t.default=h},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(1),s=n(a),c=r(22),l=n(c),u=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};i(this,e),this.core=t,this.codec=r.codec,this.timeout=1e4}return o(e,[{key:"start",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.recorder||(navigator.mediaDevices&&"function"==typeof navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia({audio:!0}).then(function(i){t.stream=i,"wav"===t.codec?t.recordWav(e,r,n):t.recordOpus(e,r,n)}):this.core.logger.debug("Voice not supported on your browser"))}},{key:"send",value:function(e,t,r){var n=new FormData;n.append("speech",e,"speech.wav"),n.append("shop_id",this.core.shop.token),n.append("did",this.core.user.did),this.core.ajax.sendPost(this.core.api.getAPIUrl("/push/say"),n).then(t,r).catch(r)}},{key:"recordWav",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=new(window.AudioContext||window.webkitAudioContext),o=i.createMediaStreamSource(this.stream);this.recorder=new l.default(o),this.recorder.record();var a=setTimeout(function(){t.core.logger.debug("Cancel recording..."),t.recorder.stop(),s.stop(),t.recorder=null,t.stream.getAudioTracks().forEach(function(e){e.stop()}),r()},this.timeout);this.core.logger.debug("Record...");var s=this.hark(this.stream,{});s.on("speaking",function(){t.core.logger.debug("speaking")}),s.on("stopped_speaking",function(){clearTimeout(a),t.core.logger.debug("stopped_speaking"),t.recorder&&(t.recorder.stop(),t.stream.getAudioTracks().forEach(function(e){e.stop()}),t.recorder.exportWAV(function(i){"function"==typeof n&&n(),t.send(i,e,r),t.recorder&&(t.recorder.clear(),t.recorder=null)},"audio/wav")),r(),s.stop()})}},{key:"recordOpus",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.recorder=new MediaRecorder(this.stream),this.recorder.start(),this.core.logger.debug("Record...");var i=setTimeout(function(){t.core.logger.debug("Cancel recording..."),t.recorder.stop(),a.stop(),t.recorder=null,t.stream.getAudioTracks().forEach(function(e){e.stop()}),r()},this.timeout),o=[];this.recorder.addEventListener("dataavailable",function(e){o.push(e.data)}),this.recorder.addEventListener("stop",function(){"function"==typeof n&&n(),t.send(new Blob(o,{type:"audio/ogg; codecs=opus"}),e,r)});var a=this.hark(this.stream,{});a.on("speaking",function(){t.core.logger.debug("speaking")}),a.on("stopped_speaking",function(){t.core.logger.debug("stopped_speaking"),clearTimeout(i),t.recorder.stop(),a.stop(),t.stream.getAudioTracks().forEach(function(e){e.stop()}),r(),t.recorder=null})}},{key:"hark",value:function(e,t){function r(e,t){var r=-1/0;e.getFloatFrequencyData(t);for(var n=4,i=t.length;n<i;n++)t[n]>r&&t[n]<0&&(r=t[n]);return r}var n=window.webkitAudioContext||window.AudioContext,i=this;if(i.events={},i.on=function(e,t){i.events[e]=t},i.emit=function(){i.events[arguments[0]]&&i.events[arguments[0]](arguments[1],arguments[2],arguments[3],arguments[4])},!n)return i;t=t||{};var o=t.smoothing||.1,a=t.interval||50,s=t.threshold,c=t.play,l=t.history||15,u=!0;window.audioContext00||(window.audioContext00=new n);var d=audioContext00.createGain();d.connect(audioContext00.destination),d.gain.value=0;var h=void 0,p=void 0,f=void 0;f=audioContext00.createAnalyser(),f.fftSize=512,f.smoothingTimeConstant=o,p=new Float32Array(f.fftSize),h=audioContext00.createMediaStreamSource(e),s=s||-50,h.connect(f),c&&f.connect(audioContext00.destination),i.speaking=!1,i.setThreshold=function(e){s=e},i.setInterval=function(e){a=e},i.stop=function(){u=!1,i.emit("volume_change",-100,s),i.speaking&&(i.speaking=!1,i.emit("stopped_speaking"))},i.speakingHistory=[];for(var m=0;m<l;m++)i.speakingHistory.push(0);return function e(){setTimeout(function(){if(u){var t=r(f,p);i.emit("volume_change",t,s);var n=0;if(t>s&&!i.speaking){for(var o=i.speakingHistory.length-3;o<i.speakingHistory.length;o++)n+=i.speakingHistory[o];n>=2&&(i.speaking=!0,i.emit("speaking"))}else if(t<s&&i.speaking){for(var a=0;a<i.speakingHistory.length;a++)n+=i.speakingHistory[a];0===n&&(i.speaking=!1,i.emit("stopped_speaking"))}i.speakingHistory.shift(),i.speakingHistory.push(0+(t>s)),e()}},a)}(),i}}],[{key:"init",value:function(e,t){if(e.speech){var r=document.createElement("div");r.classList.add(e.label.fullName()+"-search-mic"),t.insertAdjacentElement("afterEnd",r),s.default.addEvent(r,"click",function(n){n.preventDefault(),n.stopPropagation(),r.classList.add(e.label.fullName()+"-search-mic-active"),e.speech.start(function(n){r.classList.remove(e.label.fullName()+"-search-mic-active"),r.classList.remove(e.label.fullName()+"-search-mic-processing"),t.value=n.text,n.text&&s.default.dispatchEvent(t,"focus")},function(){r.classList.remove(e.label.fullName()+"-search-mic-active"),r.classList.remove(e.label.fullName()+"-search-mic-processing")},function(){r.classList.remove(e.label.fullName()+"-search-mic-active"),r.classList.add(e.label.fullName()+"-search-mic-processing")})})}}}]),e}();t.default=u},function(e,t){var r;r=function(){return this}();try{r=r||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(r=window)}e.exports=r},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.Core=void 0;var i=r(1),o=n(i),a=r(30),s=n(a),c=new s.default("production","r46","rees46",!1);window[c.name()]=function(e){var t=new o.default(e,{debug:["development","build","technodom_build"].indexOf("production")>=0,label:c,host:"api.rees46.ru",master_host:"cdn.rees46.ru",pictures_host:"pictures.rees46.ru"});return function(){t.push(arguments)}}(window[c.name()].q),t.Core=o.default},function(e,t,r){"use strict";function n(){if(c.length)throw c.shift()}function i(e){var t;t=s.length?s.pop():new o,t.task=e,a(t)}function o(){this.task=null}var a=r(6),s=[],c=[],l=a.makeRequestCallFromTimer(n);e.exports=i,o.prototype.call=function(){try{this.task.call()}catch(e){i.onerror?i.onerror(e):(c.push(e),l())}finally{this.task=null,s[s.length]=this}}},function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(32),s=function(e){return e&&e.__esModule?e:{default:e}}(a),c=r(39),l=function(){function e(t){n(this,e),this.core=t}return o(e,[{key:"send",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return"post"===e.toLowerCase()?this.sendPost(t,r):this.sendGet(t,r)}},{key:"sendWithRetry",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return this.send(e,t,n).catch(function(o){r.core.pushError(o,e,t,n),"function"==typeof i&&i(o)})}},{key:"sendGet",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r="";return t instanceof URLSearchParams?(t.set("referer",document.URL||""),this.core.stream&&t.set("stream",this.core.stream),r=""+t):"object"===(void 0===t?"undefined":i(t))&&(this.core.testMode&&(t.testmode=!0),t.referer=document.URL||"",this.core.stream&&(t.stream=this.core.stream),r=c(t)),new s.default(function(t,n){var i=window.XDomainRequest||window.XMLHttpRequest,o=new i;o.withCredentials=!0;var a=function(){var e=Error(o.statusText);e.code=o.status,n(e)},s=function(){if(4===o.readyState){if(200===o.status){var e=o.responseText;o.getResponseHeader("Content-Type").match(/application\/json/)&&(e=JSON.parse(e)),"function"==typeof t&&t(e)}o.status>=400&&a()}},c=function(){var e=o.responseText;e=JSON.parse(e),"function"==typeof t&&t(e)};i===window.XDomainRequest?(o.open("GET",e+"?"+r,!0),o.onload=c,o.onerror=a,o.send(null)):(o.open("GET",e+"?"+r,!0),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.onload=s,o.onerror=a,o.send(null))})}},{key:"sendPost",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return"object"===(void 0===t?"undefined":i(t))&&t.constructor!==FormData&&(this.core.testMode&&(t.testmode=!0),t.referer=document.URL||"",this.core.stream&&(t.stream=this.core.stream),t=JSON.stringify(t)),new s.default(function(r,n){var i=new window.XMLHttpRequest;i.withCredentials=!0;var o=function(){var e=Error(i.statusText);e.code=i.status,n(e)},a=function(){if(4===i.readyState&&i.status>=200&&i.status<300){var e=i.responseText;e&&(e=JSON.parse(e)),"function"==typeof r&&r(e)}i.status>=500&&o()};i.open("POST",e,!0),"string"==typeof t&&i.setRequestHeader("Content-Type","application/json"),i.onload=a,i.onerror=o,i.send(t)})}}]),e}();t.default=l},function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=function(){function e(t,r,i,o){n(this,e),this.env=t,this.host=r,this.master_host=i,this.pictures_host=o,this.url=this.getProtocol()+this.getHost()}return i(e,[{key:"getProtocol",value:function(){return("development"===this.env?location.protocol:"https:")+"//"}},{key:"getAPIUrl",value:function(e){return this.url+e}},{key:"getHost",value:function(){return this.host}},{key:"getMasterHost",value:function(){return this.master_host}},{key:"getPicturesHost",value:function(){return this.pictures_host}}]),e}();t.default=o},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(0),s=n(a),c=r(1),l=(n(c),function(){function e(){i(this,e)}return o(e,null,[{key:"setReview",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments[2],n=arguments[3];if(!t||void 0===t)return e.logger.warn("NPS: the data shouldn't be empty");var i={};return t.email&&(i.email=t.email),t.phone&&(i.phone=t.phone),t.loyalty_id&&(i.loyalty_id=t.loyalty_id),t.order_id&&(i.order_id=t.order_id),t.channel&&"string"==typeof t.channel?(i.channel=t.channel,t.category&&"string"==typeof t.category?(i.category=t.category,!t.rate||"string"!=typeof t.rate&&"number"!=typeof t.rate?e.logger.warn('NPS: the "rate" param should be string or number'):("string"==typeof t.rate&&(t.rate=parseInt(t.rate)),i.rate=t.rate,"string"!=typeof t.comment&&void 0!==t.comment?e.logger.warn('NPS: the "comment" param should be a string'):(i.comment=t.comment,"string"==typeof t.label|void 0===t.label?(i.label=t.label,void(Object.keys(i).length>0&&(i.shop_id=e.shop.token,i.did=e.user.did,i.seance=s.default.get(e.label.fullName()+"_session_code")||null,i.segment=e.segment||null,e.ajax.sendPost(e.api.getAPIUrl("/nps/create"),i).then(r,n).catch(n)))):e.logger.warn('NPS: the "label" param should be a string')))):e.logger.warn('NPS: the "category" param should be a string')):e.logger.warn('NPS: the "channel" param should be a string')}},{key:"getCategories",value:function(e,t,r){var n={shop_id:e.shop.token,did:e.user.did,seance:s.default.get(e.label.fullName()+"_session_code")||null,segment:e.segment||null};e.ajax.sendGet(e.api.getAPIUrl("/nps/categories"),n).then(t,r).catch(r)}},{key:"getChannels",value:function(e,t,r){var n={shop_id:e.shop.token,did:e.user.did,seance:s.default.get(e.label.fullName()+"_session_code")||null,segment:e.segment||null};e.ajax.sendGet(e.api.getAPIUrl("/nps/channels"),n).then(t,r).catch(r)}}]),e}());t.default=l},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(0),s=n(a),c=r(1),l=(n(c),function(){function e(){i(this,e)}return o(e,null,[{key:"last_for_user",value:function(e,t,r){var n={shop_id:e.shop.token,did:e.user.did,seance:s.default.get(e.label.fullName()+"_session_code")||null,segment:e.segment||null};e.ajax.sendGet(e.api.getAPIUrl("/orders/last_for_user"),n).then(t,r).catch(r)}}]),e}());t.default=l},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(20),s=n(a),c=r(7),l=(n(c),function(){function e(t,r){i(this,e),this.queue=new s.default(t),this.logger=r,this.initialized=!1}return o(e,[{key:"push",value:function(e){this.initialized?this.perform(e):this.queue.push(e)}},{key:"perform",value:function(){throw Error("This 'perform' is abstract method, please define in class "+this.constructor.name)}},{key:"performQueue",value:function(){if(this.logger.debug("Each queue",this),this.queue.length>0){this.logger.debug("Found "+this.queue.length+" tasks in queue",this);for(var e=void 0;null!==(e=this.queue.next());)this.perform(e)}}}]),e}());t.default=l},function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=function(){function e(){n(this,e)}return i(e,null,[{key:"counters",value:function(e,t){if(!t)throw'Argument "item" required';var r={shop_id:e.shop.token,item:t};return e.ajax.sendGet(e.api.getAPIUrl("/products/counters"),r)}}]),e}();t.default=o},function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(0),a=function(e){return e&&e.__esModule?e:{default:e}}(o),s=function(){function e(t){n(this,e),this.core=t}return i(e,[{key:"get",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return new Promise(function(r,n){var i=e.getFromCookie(t.id);i?(e.setToCookie(t.id,i),r(i)):e.core.ajax.sendGet(e.core.api.getAPIUrl("/promo_codes/fetch"),Object.assign({},{did:e.core.user.did,seance:e.core.user.seance,shop_id:e.core.shop.token},t)).then(function(n){if(!n.code)throw Error("There is no promo code in the API response. Response: "+n);e.setToCookie(t.id,n.code),r(n.code)}).catch(function(e){n(e)})})}},{key:"getFromCookie",value:function(e){return a.default.get(this.getCookieName(e))}},{key:"setToCookie",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";t&&a.default.set(this.getCookieName(e),t,{expires:7200,path:"/"},this.core)}},{key:"getCookieName",value:function(e){return this.core.label.fullName()+"_promocode_"+e}}]),e}();t.default=s},function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=function(){function e(t){n(this,e),this.queue=t||[]}return i(e,[{key:"length",get:function(){return this.queue.length}}]),i(e,[{key:"push",value:function(e){this.queue.push(e)}},{key:"getInit",value:function(){var e=this.findByName("init");if(e)return e;throw Error("Init command not found in queue")}},{key:"findByName",value:function(e){for(var t=0;t<this.queue.length;t++)if(this.queue[t][0]===e)return this.queue.splice(t,1)[0]}},{key:"next",value:function(){return this.queue.length>0?this.queue.splice(0,1)[0]:null}}]),e}();t.default=o},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(1),s=n(a),c=r(0),l=n(c),u=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];i(this,e),this.core=t,r&&this.addStyleToPage()}return o(e,[{key:"addStyleToPage",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"recone",r=document.createElement("link");r.setAttribute("rel","stylesheet"),r.setAttribute("type","text/css"),r.setAttribute("href","//"+this.core.api.getMasterHost()+"/"+t+"_css/"+this.core.shop.token+".css"),document.getElementsByTagName("head")[0].appendChild(r),r.onload=function(){e.banners(),e.popup()}}},{key:"perform",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;switch(e){case"sponsored":this[e](t,r,n);break;case"banners":this.banners(t)}}},{key:"banners",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};[].forEach.call(document.querySelectorAll(".recone-banner-block[data-id]"),function(r){t.hasOwnProperty("rewrite")&&!0===t.rewrite&&(r.innerHTML="",r.classList.remove("recone-initialized")),new d(e.core,r)})}},{key:"popup",value:function(){var e=this,t=document.querySelector('.recone-popup-block[data-type="popup"]');if(t){var r=parseInt(t.getAttribute("data-id")),n=t.getAttribute("data-category-id");if(r>0&&n){var i={did:this.core.user.did,shop_id:this.core.shop.token,id:r,seance:l.default.get(this.core.label.fullName()+"_session_code")||null,category:n};this.core.ajax.sendGet(this.core.api.getAPIUrl("/popup"),i).then(function(r){if(r.items&&r.items.length){var n="",i=void 0;for(i in r.items){var o=r.items[i];o.url=o.url+(o.url.match(/\?/)?"&":"?")+"recommended_by=popular",n+='<a href="'+o.url+'" class="'+e.core.label.fullName()+'-brand-popup__product">\n                                <div class="'+e.core.label.fullName()+'-brand-popup__product-image"><img src="'+o.image_url+'"></div>\n                                <div class="'+e.core.label.fullName()+'-brand-popup__product-title">'+o.name+'</div>\n                                <div class="'+e.core.label.fullName()+'-brand-popup__product-price">'+("₽"===o.currency?o.price+" "+o.currency:o.currency+o.price)+"</div>\n                            </a>"}t.innerHTML='<div class="'+e.core.label.fullName()+'-brand-popup">\n                            <div class="'+e.core.label.fullName()+'-brand-popup__title"><span>'+r.title+'</span><span class="'+e.core.label.fullName()+'-brand-popup__title-close">X</span></div>\n                            <div class="'+e.core.label.fullName()+'-brand-popup__products">'+n+"</div>\n                        </div>",s.default.addEvent(t.querySelector("."+e.core.label.fullName()+"-brand-popup__title-close"),"click",function(){t.innerHTML=""})}})}else this.core.logger.error("Incorrect inventory id or blank category id")}}},{key:"sponsored",value:function(e,t,r){if(!e.id)return void this.core.logger.error("Incorrect data id",this);var n={shop_id:this.core.shop.token,did:this.core.user.did,id:e.id,seance:l.default.get(this.core.label.fullName()+"_session_code")||null};e.category&&(n.category=e.category),e.extended&&(n.extended=e.extended),this.core.ajax.sendGet(this.core.api.getAPIUrl("/sponsored"),n).then(t).catch(function(e){if(!r)throw Error(e);r(e)})}}]),e}(),d=function(){function e(t,r){var n=this;if(i(this,e),this.core=t,r&&!r.classList.contains("recone-initialized")){r.classList.add("recone-initialized");var o={did:this.core.user.did,shop_id:this.core.shop.token,id:r.getAttribute("data-id"),seance:this.core.user.seance};this.core.ajax.sendGet(this.core.api.getAPIUrl("/banner"),o).then(function(e){if(e.banners.length){var t=document.createElement("img");t.classList.add("recone-banner-template"),t.src=e.banners[0].image,t.style.visibility="hidden",r.style.maxWidth=e.settings.width+"px",r.appendChild(t);var i=document.createElement("div");i.classList.add("recone-banner-container-control"),r.appendChild(i);for(var o=0;o<e.banners.length;o++)e.banners.length>1&&i.appendChild(n.makeRadioControl(r,e,o)),i.appendChild(n.makeBanner(e.banners[o]));e.banners.length>1&&(r.appendChild(n.bannerControl("left",function(){n.bannerPrev(r,e)})),r.appendChild(n.bannerControl("right",function(){n.bannerNext(r,e)}))),n.bannerChangeActive(r,0)}})}}return o(e,[{key:"bannerControl",value:function(e,t){var r=document.createElement("div");return r.classList.add("recone-banner-control-"+e),r.innerHTML='<svg width="32" height="32" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n  <g fill="#657786" fill-rule="evenodd">\n    <path id="a" d="M8 9L4 5 3 6l5 5 5-5-1-1z"/>\n  </g>\n</svg>',s.default.addEvent(r,"click",t),r}},{key:"bannerRunTimer",value:function(e,t){var r=this;this.bannerTimer&&clearTimeout(this.bannerTimer),t.banners.length>1&&(this.bannerTimer=setTimeout(function(){r.bannerNext(e,t)},1e3*t.settings.timeout))}},{key:"bannerNext",value:function(e,t){var r=e.querySelector("input."+this.core.label.fullName()+"-banner-control:checked"),n=r?r.value-1:0;n++,n>=t.banners.length&&(n=0),this.bannerChangeActive(e,n)}},{key:"bannerPrev",value:function(e,t){var r=e.querySelector("input."+this.core.label.fullName()+"-banner-control:checked"),n=r?r.value-1:0;n--,n<0&&(n=t.banners.length-1),this.bannerChangeActive(e,n)}},{key:"bannerChangeActive",value:function(e,t){var r=e.querySelectorAll("input."+this.core.label.fullName()+"-banner-control")[t];r&&(r.checked=!0,s.default.dispatchEvent(r,"change"))}},{key:"makeRadioControl",value:function(e,t,r){var n=this,i=document.createElement("input"),o=t.banners[r];return i.setAttribute("type","radio"),i.setAttribute("id",this.core.label.fullName()+"_carousel_control_"+e.getAttribute("data-id")+"_"+o.position),i.setAttribute("name",this.core.label.fullName()+"-carousel-"+e.getAttribute("data-id")),i.classList.add(this.core.label.fullName()+"-banner-control"),i.value=o.position,s.default.addEvent(i,"change",function(){n.bannerRunTimer(e,t);for(var r=i.cloneNode(!1);i.firstChild;)r.appendChild(i.lastChild);i.parentNode.replaceChild(r,i),s.default.addEvent(r,"change",function(){n.bannerRunTimer(e,t)})}),i}},{key:"makeBanner",value:function(e){var t=this,r=document.createElement("a");r.setAttribute("href",e.url),r.setAttribute("target","_blank"),r.setAttribute("rel","nofollow"),r.style.position="absolute",r.style.top="0",r.onclick=function(){window[t.core.label.name()]("track","recone_click",{id:e.id,inventory:e.inventory,position:e.position,recommended_by:"banner"})};var n=document.createElement("img");return n.onload=function(){},n.src=e.image,r.appendChild(n),r}}]),e}();t.default=u},function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.Recorder=void 0;var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(31),a=function(e){return e&&e.__esModule?e:{default:e}}(o),s=t.Recorder=function(){function e(t,r){var i=this;n(this,e),this.config={bufferLen:4096,numChannels:2,mimeType:"audio/wav"},this.recording=!1,this.callbacks={getBuffer:[],exportWAV:[]},Object.assign(this.config,r),this.context=t.context,this.node=(this.context.createScriptProcessor||this.context.createJavaScriptNode).call(this.context,this.config.bufferLen,this.config.numChannels,this.config.numChannels),this.node.addEventListener("audioprocess",function(e){if(i.recording){for(var t=[],r=0;r<i.config.numChannels;r++)t.push(e.inputBuffer.getChannelData(r));i.worker.postMessage({command:"record",buffer:t})}}),t.connect(this.node),this.node.connect(this.context.destination);var o={};this.worker=new a.default(function(){function e(e){p=e.sampleRate,f=e.numChannels,o()}function t(e){for(var t=0;t<f;t++)h[t].push(e[t]);d+=e[0].length}function r(e){for(var t=[],r=0;r<f;r++)t.push(a(h[r],d));var n=void 0;n=2===f?s(t[0],t[1]):t[0];var i=u(n),o=new Blob([i],{type:e});this.postMessage({command:"exportWAV",data:o})}function n(){for(var e=[],t=0;t<f;t++)e.push(a(h[t],d));this.postMessage({command:"getBuffer",data:e})}function i(){d=0,h=[],o()}function o(){for(var e=0;e<f;e++)h[e]=[]}function a(e,t){for(var r=new Float32Array(t),n=0,i=0;i<e.length;i++)r.set(e[i],n),n+=e[i].length;return r}function s(e,t){for(var r=e.length+t.length,n=new Float32Array(r),i=0,o=0;i<r;)n[i++]=e[o],n[i++]=t[o],o++;return n}function c(e,t,r){for(var n=0;n<r.length;n++,t+=2){var i=Math.max(-1,Math.min(1,r[n]));e.setInt16(t,i<0?32768*i:32767*i,!0)}}function l(e,t,r){for(var n=0;n<r.length;n++)e.setUint8(t+n,r.charCodeAt(n))}function u(e){var t=new ArrayBuffer(44+2*e.length),r=new DataView(t);return l(r,0,"RIFF"),r.setUint32(4,36+2*e.length,!0),l(r,8,"WAVE"),l(r,12,"fmt "),r.setUint32(16,16,!0),r.setUint16(20,1,!0),r.setUint16(22,f,!0),r.setUint32(24,p,!0),r.setUint32(28,4*p,!0),r.setUint16(32,2*f,!0),r.setUint16(34,16,!0),l(r,36,"data"),r.setUint32(40,2*e.length,!0),c(r,44,e),r}var d=0,h=[],p=void 0,f=void 0;this.onmessage=function(o){switch(o.data.command){case"init":e(o.data.config);break;case"record":t(o.data.buffer);break;case"exportWAV":r(o.data.type);break;case"getBuffer":n();break;case"clear":i()}}},o),this.worker.postMessage({command:"init",config:{sampleRate:this.context.sampleRate,numChannels:this.config.numChannels}}),this.worker.onmessage=function(e){var t=i.callbacks[e.data.command].pop();"function"==typeof t&&t(e.data.data)}}return i(e,[{key:"record",value:function(){this.recording=!0}},{key:"stop",value:function(){this.recording=!1}},{key:"clear",value:function(){this.worker.postMessage({command:"clear"})}},{key:"getBuffer",value:function(e){if(!(e=e||this.config.callback))throw Error("Callback not set");this.callbacks.getBuffer.push(e),this.worker.postMessage({command:"getBuffer"})}},{key:"exportWAV",value:function(e,t){if(t=t||this.config.mimeType,!(e=e||this.config.callback))throw Error("Callback not set");this.callbacks.exportWAV.push(e),this.worker.postMessage({command:"exportWAV",type:t})}}],[{key:"forceDownload",value:function(e,t){var r=(window.URL||window.webkitURL).createObjectURL(e),n=window.document.createElement("a");n.href=r,n.download=t||"output.wav";var i=document.createEvent("Event");i.initEvent("click",!0,!0),n.dispatchEvent(i)}}]),e}();t.default=s},function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=function(){function e(t){n(this,e),this.core=t}return i(e,[{key:"perform",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;switch(e){case"css":this.core.addStyleToPage("reputation_css");break;case"get":case"product":case"widget":this[e](t,r)}}},{key:"get",value:function(e,t){var r={shop_id:this.core.shop.token};e.count&&(r.count=e.count),e.offset&&(r.offset=e.offset),this.core.ajax.sendGet(this.core.api.getAPIUrl("/reputation/shop"),r).then(t)}},{key:"product",value:function(e,t){if(!e.product_id)throw Error("Reputation: product_id not set");var r={shop_id:this.core.shop.token,product_id:e.product_id};e.count&&(r.count=e.count),e.offset&&(r.offset=e.offset),this.core.ajax.sendGet(this.core.api.getAPIUrl("/reputation/product"),r).then(t)}},{key:"widget",value:function(e,t){if(!e.style||-1===["white","green","grey"].indexOf(e.style))throw Error("Reputation: style is incorrect, please set in white, green, grey");var r={shop_id:this.core.shop.token,style:e.style};this.core.ajax.sendGet(this.core.api.getAPIUrl("/reputation/widget"),r).then(t)}}]),e}();t.default=o},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(1),c=n(s),l=r(9),u=n(l),d=r(5),h=n(d),p=r(3),f=n(p),m=r(0),g=n(m),b=function(){function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};i(this,e),t.classList.add(r.label.fullName()+"-instant-search-rendered"),this.core=r,this.initialize=!1,this.initialize_last_queries=!1,this.timer=null,this.results_object=null,this.active_item=-1,this.query_cache=[],this.top_products=[],this.last_queries=[],n.enabled&&(this.input=t,this.options=n,this.append_to_body=void 0===this.options.settings.append_to_body||this.options.settings.append_to_body,c.default.isMobile()||window.innerWidth,this.init())}return a(e,[{key:"init",value:function(){var e=this;this.core.addStyleToPage("search_css"),this.box=this.createItem("box"),this.box.classList.add(this.core.label.fullName()+"-search-box__"+this.options.type),this.input.setAttribute("autocomplete","off"),this.input_url=this.input.getAttribute("data-"+this.core.label.fullName()+"-search-url"),this.input_url_prefix=this.input.getAttribute("data-"+this.core.label.fullName()+"-search-url-prefix"),this.append_to_body?(document.body.appendChild(this.box),this.box.classList.add(this.core.label.fullName()+"-search-box-body"),this.setBoxPosition(!0)):(this.input.parentNode.insertBefore(this.box,this.input),this.box.appendChild(this.input)),this.results=this.createItem("results"),this.box.appendChild(this.results),c.default.addEvent(this.input,"keydown",function(e){-1!==[13,38,40].indexOf(e.keyCode)&&e.preventDefault()}),c.default.addEvent(this.input,"paste",this.search.bind(this)),c.default.addEvent(this.input,"keyup",this.search.bind(this)),c.default.addEvent(this.input,"focus",this.search.bind(this)),c.default.addEvent(this.input,"click",this.search.bind(this));var t=function(e,t){for(var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=null;e;){if(e.matches(t)){n=e;break}if(r&&e.matches(r))break;e=e.parentElement}return n}(this.input,"form");t&&c.default.addEvent(t,"submit",function(t){t.preventDefault(),window.location=e.landingUrl(e.input.value)}),this.core.logger.debug("initialized",this),u.default.init(this.core,this.input)}},{key:"init_last_queries",value:function(e){var t=this;if(this.options.settings.enable_last_queries)if(this.initialize_last_queries)e();else{var r={shop_id:this.core.shop.token,did:this.core.user.did};this.core.ajax.sendGet(this.core.api.getAPIUrl("/search/blank"),r).then(function(r){t.last_queries=r.last_queries||[],t.suggests=r.suggests,t.last_products=r.last_products?r.products:[],t.top_products=r.last_products?[]:r.products,t.initialize_last_queries=!0,t.blank_html=r.html,e()})}}},{key:"search",value:function(e){var t=this;switch("paste"!==e.type&&(e.preventDefault(),e.stopPropagation()),e.keyCode){case 27:this.clear();break;case 40:e.preventDefault(),this.size()&&++this.active_item>=this.size()&&(this.active_item=0),this.changeActive(!0);break;case 38:e.preventDefault(),this.size()&&--this.active_item<0&&(this.active_item=this.size()-1),this.changeActive(!0);break;case 13:if(e.preventDefault(),e.stopPropagation(),"true"===g.default.get(this.core.label.fullName()+"_debug_mode")&&(console.log("Check redirect rules"),console.log(this.options.settings.enable_full_search),console.log(this.active_item),console.log(this.input.value),console.log(this.results_object.products_total),console.log(this.getRedirectLink(this.input.value))),this.options.settings.enable_full_search)if(this.active_item>=0){var r=this.results.querySelector("."+this.core.label.fullName()+"-search-row__active");r&&r.click()}else this.input.value&&(1!==this.results_object.products_total||this.getRedirectLink(this.input.value)?document.location=this.landingUrl(this.input.value):document.location=this.results_object.products[0].url);break;case 17:case 18:case 91:break;default:this.timer&&(clearTimeout(this.timer),this.timer=null),this.timer=setTimeout(function(){t.input.value&&t.input.value.trim().length>=1?t.input.value===t.last_search&&t.results_object&&t.results_object.search_query?t.printResults(t.results_object):(t.last_search=t.input.value,t.core.logger.debug("Search: "+t.last_search),t.get(t.input.value).then(t.printResults.bind(t))):t.init_last_queries(function(){t.options.settings.enable_last_queries&&(t.top_products.length||t.last_products.length)||t.last_queries&&t.last_queries.length||t.suggests.length?t.printResults({categories:[],products:t.top_products,last_products:t.last_products,virtual_categories:[],queries:t.suggests,last_queries:t.last_queries,collections:[],search_query_redirects:{},search_query:t.input.value,search_blank:!0,html:t.blank_html}):t.results.innerHTML=""})},"paste"===e.type?4:200)}}},{key:"get",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,i={shop_id:this.core.shop.token,did:this.core.user.did,sid:this.core.user.seance,type:"instant_search",search_query:e};return this.input.dataset.locations&&(i.locations=this.input.dataset.locations),r&&(i.exact_field_match=r),t&&(i.subquery=t),n&&(i.categories=n),this.core.ajax.sendGet(this.core.api.getAPIUrl("/search"),i)}},{key:"printResults",value:function(e){var t=this;if(this.core.logger.debugLevel&&e&&console.log(this.input.value,e.search_query),e&&(this.clear(),this.results_object=e,this.active_item=-1,(0!==this.size()||0!==e.products.length||e.last_products&&0!==e.last_products.length)&&this.options.landing)){this.append_to_body&&this.setBoxPosition(),this.overlay=this.createItem("overlay"),document.body.appendChild(this.overlay),c.default.addEvent(this.overlay,"click",function(){t.clear(),t.input.blur()});var r=void 0,n=void 0,i=void 0;if(e.html)this.results.innerHTML=e.html,r=this.results.querySelector("."+this.core.label.fullName()+"-search-wrapper"),this.container=n=this.results.querySelector("."+this.core.label.fullName()+"-search-container"),i=this.results.querySelector("."+this.core.label.fullName()+"-search-close"),[].forEach.call(n.querySelectorAll("."+this.core.label.fullName()+'-search-row[data-remote="true"]'),function(e){c.default.addEvent(e,"mouseover",function(r){t.timer&&(clearTimeout(t.timer),t.timer=null),t.timer=setTimeout(function(){t.active_item=Array.prototype.slice.call(t.container.querySelectorAll("."+t.core.label.fullName()+"-search-row")).indexOf(e),t.changeActive(),t.get(e.getAttribute("data-id")?t.input.value:e.textContent.trim(),!0,null,e.getAttribute("data-id")).then(function(r){return t.printProducts(r,e.textContent.trim())})},200)})}),[].forEach.call(n.querySelectorAll("."+this.core.label.fullName()+"-search-container:first-child ."+this.core.label.fullName()+"-search-group-description"),function(e){c.default.addEvent(e,"mouseout",function(){t.timer&&(clearTimeout(t.timer),t.timer=null)})});else{n=this.createItem("container"),r=this.createItem("wrapper"),i=this.createItem("close");var o=this.createItem("container");this.results.appendChild(r),r.appendChild(n),r.appendChild(o),r.appendChild(i),o.setAttribute("id",this.core.label.fullName()+"_search_products"),this.container=n;var a=function(e,r){n.appendChild(t.createGroup(e.map(function(e){return"suggested"!==t.options.type&&(e.callback=function(){t.query_cache[e.name]?t.printProducts(t.query_cache[e.name],e.name):t.get(e.name,!0).then(function(r){t.printProducts(r,e.name)})}),e}),r))};e.last_queries&&e.last_queries.length&&a(e.last_queries,this.options.settings.last_queries_title||"Last queries"),e.queries&&e.queries.length&&a(e.queries,this.options.settings.suggestions_title||"Suggestions"),"suggested"!==this.options.type&&e.categories&&e.categories.length&&n.appendChild(this.createGroup(e.categories.map(function(e){return"suggested"!==t.options.type&&(e.callback=function(){var r="category-"+e.name+"-"+e.id+"-"+t.input.value;t.query_cache[r]?t.printProducts(t.query_cache[r],r):t.get(t.input.value,!0,null,e.id).then(function(e){t.printProducts(e,r)})}),e}),this.options.settings.categories_title||"Categories")),e.search_blank&&(this.options.settings.popular_categories_title&&this.options.settings.popular_categories&&this.options.settings.popular_categories.length>0&&n.appendChild(this.createGroup(this.options.settings.popular_categories,this.options.settings.popular_categories_title)),this.options.settings.popular_brands_title&&this.options.settings.popular_brands&&this.options.settings.popular_brands.length>0&&n.appendChild(this.createGroup(this.options.settings.popular_brands,this.options.settings.popular_brands_title)),this.options.settings.popular_links_title&&this.options.settings.popular_links&&this.options.settings.popular_links.length>0&&n.appendChild(this.createGroup(this.options.settings.popular_links,this.options.settings.popular_links_title))),"suggested"!==this.options.type&&e.collections&&e.collections.length&&(this.results_object.collections=e.collections.map(function(e){return e.url=t.options.landing.replace(/%query%/g,t.input.value)+""+t.getQueryParamChar(t.options.landing)+t.core.label.name()+"_search_collection="+e.id,e}),n.appendChild(this.createGroup(e.collections,"Sets"))),"suggested"!==this.options.type&&[["book_author",this.options.settings.book_author_title||"Authors"],["book_editor","Редактор"],["book_publisher","Издательство"],["book_series","Серия"],["book_illustrator","Иллюстратор"]].forEach(function(r){e[r[0]]&&e[r[0]].length&&n.appendChild(t.createGroup(e[r[0]].map(function(e){return"suggested"!==t.options.type&&(e.callback=function(){var n="author-"+e.name;t.query_cache[n]?t.printProducts(t.query_cache[n],n):t.get(e.name,!0,r[0]).then(function(e){t.printProducts(e,n)})}),e}),r[1]))})}if(void 0!==r.getBoundingClientRect&&"suggested"!==this.options.type){var s=r.getBoundingClientRect(),l=0===this.size()?471:719;window.innerWidth&&(s.left<.6*window.innerWidth&&s.right>.4*window.innerWidth&&s.left+l>window.innerWidth?r.style.marginLeft=this.input.getBoundingClientRect().width/2-l/2+"px":s.left>=.6*window.innerWidth&&(r.classList.add(this.core.label.fullName()+"-search-wrapper__right"),r.style.marginLeft=-l+this.input.getBoundingClientRect().width+"px"))}if(c.default.addEvent(i,"click",function(e){e.preventDefault(),e.stopPropagation(),t.clear()}),this.input.getAttribute("data-inventory-banner")&&!c.default.isMobile()){var u=document.createElement("div");u.setAttribute("class","recone-banner-block"),u.setAttribute("data-type","banner"),u.setAttribute("data-id",this.input.getAttribute("data-inventory-banner")),n.appendChild(u),this.core.recone.banners()}if(this.input.getAttribute("data-inventory-item")&&!c.default.isMobile()){var d=document.createElement("div");d.setAttribute("class","recone-premium-block"),n.appendChild(d),this.core.recone.sponsored({id:this.input.getAttribute("data-inventory-item"),extended:!0},function(e){e.length&&d.appendChild(t.productHtml(e[0]))})}if(this.active_item=-1,this.changeActive(),"suggested"!==this.options.type){this.printProducts(e,this.input.value);var h=this.input.getAttribute("data-"+this.core.label.fullName()+"-instant-search-callback");h&&(void 0===window[h]?console.error("Global function "+h+" is not defined"):window[h](this.input,this.box,e))}}}},{key:"printProducts",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=this.results.querySelector("#"+this.core.label.fullName()+"_search_products");if(i.innerHTML="",e.html){var o=document.createElement("div");o.innerHTML=e.html,i.innerHTML=o.querySelector("#"+this.core.label.fullName()+"_search_products").innerHTML}else this.query_cache[t]||(this.query_cache[t]=e);var a=e.last_products&&e.last_products.length?e.last_products:e.products,s=void 0;if(a.length){if(e.html)s=i.querySelector("."+this.core.label.fullName()+"-search-group");else{s=this.createItem("group"),i.appendChild(s),s.classList.add(this.core.label.fullName()+"-search-products");var l=this.createItem("group-title");e.last_products&&e.last_products.length?l.innerText=this.options.settings.last_products_title||"Recently viewed":l.innerText=this.options.settings.items_title||"Possible item matches",s.appendChild(l);var u=this.createItem("group-description");s.appendChild(u);for(var d=0;d<a.length;d++)u.appendChild(this.productHtml(a[d]))}if((n||this.input.value.length>1)&&this.options.settings.enable_full_search){var h=this.createItem("group-description"),p=this.createItem("row","a");null===n&&(n=this.results.querySelector("."+this.core.label.fullName()+"-search-row__active")),s.appendChild(h),h.appendChild(p),p.setAttribute("href",n?n.getAttribute("href"):this.landingUrl(this.input.value)),p.textContent=(this.options.settings.show_all_title||this.options.results_title).replace("%query%",n?n.textContent:this.input.value).replace("%count%",e.products_total||"")}if(c.default.isMobile()&&"true"===g.default.get("rees46_testmode")){var f=function(e,t,r){var n,i,o,a,s,c,l,u,d,h,p;o=e.length,a=t.length,r=r||{};var f=r.replace||1,m=r.replaceCase||r.replace||1,g=r.insert||1,b=r.remove||1;p=s=Math.max(o,a);var v=Math.min(b,g,f),y=Math.max(v,(o-a)*b),_=Math.max(v,(a-o)*g),w=Array(2*p-1);for(n=0;n<=a;++n)w[n]=n*y;for(n=0;n<o;++n,s=p-s)for(c=e[n],l=c.toLowerCase(),w[s]=(n+1)*_,u=s,d=p-s,i=0;i<a;++i,++u,++d)h=c===t[i]?0:l===t[i].toLowerCase()?m:f,w[u+1]=Math.min(w[d+1]+b,w[u]+g,w[d]+h);return w[a+p-s]},m=[],b=[],v=[],y=[],_=e.search_query.split(" "),w=_[_.length-1],k=this.createItem("hints"),x=this.createItem("replaces");e.queries.forEach(function(e){e.name.split(" ").forEach(function(e){return m.push(e)})}),m.forEach(function(e){b.length>0?b.forEach(function(t){f(t,e)>2&&b.push(e)}):b.push(e)}),b=new Set(b),b.forEach(function(t){-1==t.indexOf(w)?e.search_query.split(" ").includes(t)||v.push(t):t!==w&&y.push(t)}),v.length>0&&(v.forEach(function(e){var t=document.createElement("button");t.classList.add("hint"),t.innerHTML=e,k.appendChild(t)}),s.prepend(k),k.querySelectorAll("button.hint").forEach(function(t){t.addEventListener("click",function(n){n.preventDefault();var i=e.search_query+" "+t.innerText;r.input.value=i,r.get(i,null,null,null).then(function(e){return r.printProducts(e)})})})),y&&(y.forEach(function(e){var t=document.createElement("button");t.classList.add("replace"),t.innerHTML=e,x.appendChild(t)}),s.prepend(x),x.querySelectorAll("button.replace").forEach(function(t){t.addEventListener("click",function(n){n.preventDefault();var i=e.search_query.replace(w,t.innerHTML);r.input.value=i,r.get(i,null,null,null).then(function(e){return r.printProducts(e)})})}))}}}},{key:"productHtml",value:function(e){var t=this.createItem("product","a");return t.setAttribute("href",this.urlWithPrefix(e.url)),t.innerHTML='<div class="'+this.core.label.fullName()+'-search-product__image" style="background-image: url(\''+(e.picture||e.image_url)+'\')"></div><div class="'+this.core.label.fullName()+'-search-product__name">'+e.name+"</div>"+(this.options.settings.enable_old_price?'<div class="'+this.core.label.fullName()+'-search-product__old_price">'+(e.oldprice_full>0?e.oldprice_formatted:"")+"</div>":"")+'<div class="'+this.core.label.fullName()+'-search-product__price">'+e.price_formatted+"</div>",t}},{key:"getQueryParamChar",value:function(e){return-1===e.indexOf("?")?"?":"&"}},{key:"createGroup",value:function(e,t){var r=this,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=this.createItem("group"),o=this.createItem("group-title");o.innerText=t,i.appendChild(o);var a=this.createItem("group-description");return i.appendChild(a),c.default.addEvent(a,"mouseout",function(){r.timer&&(clearTimeout(r.timer),r.timer=null)}),e.forEach(function(e){var t=r.createItem("row","a");e.callback?(c.default.addEvent(t,"mouseover",function(n){r.timer&&(clearTimeout(r.timer),r.timer=null),r.timer=setTimeout(function(){r.active_item=Array.prototype.slice.call(r.container.querySelectorAll("."+r.core.label.fullName()+"-search-row")).indexOf(t),r.changeActive(),e.callback()},200)}),t.setAttribute("href",e.url&&!r.getRedirectLink(e.name)?r.urlWithPrefix(e.url):r.landingUrl(e.name))):t.setAttribute("href",r.urlWithPrefix(e.url));var i=document.createElement("span");i.textContent=e.name,r.input.value&&n&&(i.innerHTML=i.innerHTML.replace(RegExp("("+r.input.value.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")+")","i"),"<b>$1</b>")),t.appendChild(i),a.appendChild(t)}),i}},{key:"size",value:function(){return("suggested"!==this.options.type&&this.results_object.categories?this.results_object.categories.length:0)+(this.results_object.queries?this.results_object.queries.length:0)+("suggested"!==this.options.type&&this.results_object.collections?this.results_object.collections.length:0)}},{key:"clear",value:function(){this.results&&(this.results.innerHTML=""),this.overlay&&(this.overlay.parentNode.removeChild(this.overlay),this.overlay=null)}},{key:"urlWithPrefix",value:function(e){return e.match(/^\//)&&this.input_url_prefix&&(e=this.input_url_prefix+e),e}},{key:"landingUrl",value:function(e){if(this.results_object&&this.results_object.search_query_redirects&&this.results_object.search_query_redirects.redirect_link)return this.results_object.search_query_redirects.redirect_link;var t=this.urlWithPrefix(this.getRedirectLink(e)||this.input_url||this.options.landing);return t?t.replace(/%query%/g,encodeURIComponent(e))+""+this.getQueryParamChar(t)+this.core.label.name()+"_search_query="+encodeURIComponent(e)+"&"+this.core.label.name()+"_input_query="+encodeURIComponent(this.input.value):"#"}},{key:"getRedirectLink",value:function(e){return e=e?e.toLowerCase().trim().replace(/\s+/g," "):"",e.length>0&&this.core.search.settings.redirects&&this.core.search.settings.redirects[e]?this.core.search.settings.redirects[e]:null}},{key:"changeActive",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.size()&&[].forEach.call(this.results.querySelectorAll("."+this.core.label.fullName()+"-search-row"),function(r,n){n===e.active_item?(r.classList.add(e.core.label.fullName()+"-search-row__active"),t&&r.dispatchEvent(new MouseEvent("mouseover"))):r.classList.remove(e.core.label.fullName()+"-search-row__active")})}},{key:"createItem",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"div",r=document.createElement(t);return r.classList.add(this.core.label.fullName()+"-search-"+e),r}},{key:"getOffsetSum",value:function(e){for(var t=0,r=0;e;)t+=parseFloat(e.offsetTop),r+=parseFloat(e.offsetLeft),e=e.offsetParent;return{top:Math.round(t),left:Math.round(r)}}},{key:"getOffsetRect",value:function(e){var t=e.getBoundingClientRect(),r=document.body,n=document.documentElement,i=window.pageYOffset||n.scrollTop||r.scrollTop,o=window.pageXOffset||n.scrollLeft||r.scrollLeft,a=n.clientTop||r.clientTop||0,s=n.clientLeft||r.clientLeft||0,c=t.top+i-a,l=t.left+o-s;return{top:Math.round(c),left:Math.round(l)}}},{key:"getOffset",value:function(e){return e.getBoundingClientRect?this.getOffsetRect(e):this.getOffsetSum(e)}},{key:"setBoxPosition",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],r=this.getOffset(this.input);this.box.style.top=r.top+this.input.offsetHeight+"px",this.box.style.left=r.left+"px",t&&c.default.addEvent(window,"scroll",function(){e.box.style.top=e.getOffset(e.input).top+e.input.offsetHeight+"px"})}}],[{key:"initInstantSearch",value:function(t){t.initialized&&t.search&&t.search.enabled&&[].forEach.call(document.querySelectorAll("input."+t.label.fullName()+"-instant-search:not(."+t.label.fullName()+"-instant-search-rendered)"),function(r){new e(r,t,t.search)})}},{key:"initFullSearch",value:function(e){if(e.shop.token&&e.user.did&&e.search){var t=document.querySelectorAll("."+e.label.fullName()+"-full-search-results:not(."+e.label.fullName()+"-full-search-results-rendered)");if(0===t.length)return;e.addStyleToPage("search_css");var r=!1;[].forEach.call(t,function(t,n){t.classList.add(e.label.fullName()+"-full-search-results-rendered");var i=t.getAttribute("data-search-query")||e.search_query,a=t.getAttribute("data-input-query")||e.input_query,s=void 0;if(i){var c={shop_id:e.shop.token,did:e.user.did,type:"full_search",search_query:i,input_query:a,seance:e.user.seance,exact_field_match:e.vars[e.label.name()+"_exact_field_match"]||null};if(["limit","page","offset","available","category-names","sort-by","order","filters","locations","price-min","price-max","categories","brands"].forEach(function(e){var r=t.getAttribute("data-search-"+e);r&&(c[e.replace("-","_")]=r.replace(/^\s+|\s+$/g,""))}),t.getAttribute("data-search-filters-block")&&document.querySelector(t.getAttribute("data-search-filters-block"))){var l={};try{l=JSON.parse(t.getAttribute("data-search-filters")||"{}")}catch(t){e.logger.error(t)}s=new h.default(e,c,t.getAttribute("data-search-filters-block"),"/search",l),s.setTotalResultSelector(t.getAttribute("data-search-total-block")),s.setSortSelector(t.getAttribute("data-search-sort-block"))}else e.logger.debug("Search filter block: "+t.getAttribute("data-search-filters-block")+", found: "+!!document.querySelector(t.getAttribute("data-search-filters-block")));var u=function(t,r){var n=function(r){void 0!==r.html?t.innerHTML=r.html:e.logger.error("Search template is missing."),void 0!==r.products_total&&t.setAttribute("data-search-response-total",r.products_total);var n=t.getAttribute("data-search-callback");n&&(void 0===window[n]?console.error("Global function "+n+" is not defined"):window[n](t,r))};e.logger.debug("Search attach results"),n(r),e.logger.debug("Search filters object: "+s),s&&(s.setCallback(n),s.print(r,!0))};e.logger.debug("Search request with data "+JSON.stringify(c)),e.ajax.sendGet(e.api.getAPIUrl("/search"),c).then(function(i){if(document.contains(t))u(t,i);else{e.logger.debug("Trying to find the search block again by its index if its pointer was lost.");var a=document.querySelectorAll("."+e.label.fullName()+"-full-search-results");void 0!==n&&void 0!==a[n]&&u(a[n],i)}"object"!==o(i.popup)||r||(r=!0,f.default.prepare(e,i.popup))}).catch(function(e){var r=t.getAttribute("data-search-error");r&&(void 0===window[r]?console.error("Global function "+r+" is not defined"):window[r](t))})}else e.logger.error("Search query can not be blank for div implementation")})}}}]),e}();t.default=b},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(0),s=n(a),c=r(1),l=(n(c),function(){function e(){i(this,e)}return o(e,null,[{key:"add",value:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=e.getParams(t,r);n&&Object.keys(n).length>0&&(n.shop_id=t.shop.token,n.did=t.user.did,n.seance=s.default.get(t.label.fullName()+"_session_code")||null,n.segment=t.segment||null,t.ajax.sendWithRetry("post",t.api.getAPIUrl("/segments/add"),n))}},{key:"remove",value:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=e.getParams(t,r);n&&Object.keys(n).length>0&&(n.shop_id=t.shop.token,n.did=t.user.did,n.seance=s.default.get(t.label.fullName()+"_session_code")||null,n.segment=t.segment||null,t.ajax.sendWithRetry("post",t.api.getAPIUrl("/segments/remove"),n))}},{key:"get",value:function(e,t,r){var n={shop_id:e.shop.token,did:e.user.did,seance:s.default.get(e.label.fullName()+"_session_code")||null,segment:e.segment||null};e.ajax.sendGet(e.api.getAPIUrl("/segments/get"),n).then(t,r).catch(r)}},{key:"getParams",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r={};return t&&void 0!==t?("string"==typeof t.email?r.email=t.email.trim().toLowerCase():e.logger.debug('Segments: the "email" param should be a string'),"string"==typeof t.phone?r.phone=t.phone.trim():e.logger.debug('Segments: the "phone" param should be a string'),!t.segment_id||"string"!=typeof t.segment_id&&"number"!=typeof t.segment_id?e.logger.warn("Segments: a segment ID must be specified and should be string or number")||{}:("string"==typeof t.segment_id&&(t.segment_id=parseInt(t.segment_id)),r.segment_id=t.segment_id,r)):e.logger.warn("Segments: the params shouldn't be empty")||{}}}]),e}());t.default=l},function(e,t,r){"use strict";function n(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=function(){function e(t,r){i(this,e),this.core=t,this.container=r,this.code=r.getAttribute("data-code"),r.classList.add(t.label.fullName()+"-stories-rendered"),this.buildSkeleton(),this.code?this.core.ajax.sendGet(this.core.api.getAPIUrl("/stories/"+this.code),{shop_id:this.core.shop.token,did:this.core.user.did,sid:this.core.user.seance}).then(this.printResults.bind(this)):t.logger.error("Story block code is missing")}return o(e,[{key:"buildSkeleton",value:function(){for(var e=0;e<3;e++){var t=document.createElement("div"),r=document.createElement("div"),n=document.createElement("div");r.classList.add("story-skeleton-avatar"),n.classList.add("story-skeleton-name"),t.classList.add("story-skeleton"),t.append(r,n),this.container.append(t)}}},{key:"printResults",value:function(e){this.id=e.id,this.stories=e.stories,this.stories&&this.stories.length?this.addStyleToPage().then(function(){var e=this;this.container.textContent="",this.container.classList.add(this.prefix()),document.body.addEventListener("keyup",function(t){"Escape"===t.key&&e.close()});for(var t=0;t<this.stories.length;t++)this.buildStory(t);this.updateViewed()}.bind(this)):(this.container.style.height=window.getComputedStyle(this.container).getPropertyValue("height"),this.container.textContent="")}},{key:"addStyleToPage",value:function(){var e=this,t=this.core.label.fullName()+"-story-css-"+this.id;return document.getElementById(t)?Promise.resolve():new Promise(function(r){var n=document.createElement("link");n.setAttribute("id",t),n.setAttribute("rel","stylesheet"),n.setAttribute("type","text/css"),n.setAttribute("href","//"+e.core.api.getMasterHost()+"/stories_css/"+e.core.shop.token+"_"+e.id+".css"),n.onload=r,document.getElementsByTagName("head")[0].appendChild(n)})}},{key:"buildStory",value:function(e){var t=this,r=this.stories[e],n=this.createItem("story","div"),i=this.createItem("story-avatar","img"),o=this.createItem("story-name","div");i.setAttribute("src",r.avatar),i.classList.add("loading"),o.textContent=r.name,i.onload=function(){this.classList.remove("loading")},n.append(i,o),n.addEventListener("click",function(r){r.preventDefault(),r.stopPropagation(),t.showStory(e)}),this.container.append(n)}},{key:"updateViewed",value:function(){for(var e=this.container.querySelectorAll("."+this.prefix()+"-story ."+this.prefix()+"-story-avatar"),t=0;t<this.stories.length;t++)e[t].classList.toggle(this.prefix()+"-story-avatar-not-viewed",!this.stories[t].viewed)}},{key:"showStory",value:function(e){function t(){a=!1,c=setTimeout(function(){a=!0,l.pause()},200)}function r(){clearTimeout(c)}var n=this;this.close();var i=this.createItem("background"),o=this.createItem("preview"),a=void 0,c=void 0,l=void 0,u=0,d=0;i.append(o,this.createItem("close")),i.addEventListener("click",this.close.bind(this)),o.addEventListener("mousedown",t),o.addEventListener("mouseup",r),o.addEventListener("touchstart",t),o.addEventListener("touchend",function(){r(),l.resume()}),o.addEventListener("prev",function(){e<=0?n.close():l=new s(n,o,--e)}),o.addEventListener("next",function(t){n.stories[e].viewed=!0,n.updateViewed(),e+1>=n.stories.length?n.close():l=new s(n,o,++e)}),o.addEventListener("click",function(e){e.stopPropagation(),a?l.resume():(clearTimeout(c),e.offsetX/e.target.offsetWidth<.5?l.prev():l.next())}),o.addEventListener("touchstart",function(e){u=e.changedTouches[e.changedTouches.length-1].screenX}),o.addEventListener("touchend",function(t){d=t.changedTouches[t.changedTouches.length-1].screenX,u>d&&u-d>100?o.dispatchEvent(new Event("next")):d>u&&d-u>100&&(e<=0?n.close():l=new s(n,o,--e))}),o.oncontextmenu=function(e){return e.preventDefault(),e.stopPropagation(),!1},l=new s(this,o,e),document.body.append(i)}},{key:"close",value:function(){this.interval&&clearInterval(this.interval);var e=document.querySelector("."+this.prefix()+"-background");e&&e.remove(),document.body.style.overflow=""}},{key:"createItem",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"div",r=document.createElement(t);return r.classList.add(this.prefix()+"-"+e),r}},{key:"prefix",value:function(){return this.core.label.fullName()+"-stories-"+this.id}},{key:"track",value:function(e,t,r){return this.core.ajax.sendPost(this.core.api.getAPIUrl("/stories/track"),{shop_id:this.core.shop.token,did:this.core.user.did,sid:this.core.user.seance,event:e,code:this.code,story_id:t,slide_id:r})}}],[{key:"init",value:function(t){t.shop.token&&t.user.did&&t.user.seance&&[].forEach.call(document.querySelectorAll("."+t.label.fullName()+"-stories[data-code]:not(."+t.label.fullName()+"-stories-rendered)"),function(r){new e(t,r)})}}]),e}(),s=function(){function e(t,r,o){var a=this;i(this,e),this.parent=t,this.position=o,this.progress=new c(this,t.stories[o]),this.container=this.parent.createItem("container"),this.carousel=this.parent.createItem("carousel"),this.preview=r,this.active=!1,this.shadowLayer=this.parent.createItem("shadow"),this.nextSlideContainer="",this.prevSlideContainer="",this.shadowLayer.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation()}),window.screen.width>=980&&(this.prevSlideContainer=this.parent.createItem("prev"),this.nextSlideContainer=this.parent.createItem("next"),this.prevSlideContainer.addEventListener("click",function(e){e.stopPropagation(),e.preventDefault(),0===a.position?a.parent.close():a.preview.dispatchEvent(new Event("prev"))}),this.nextSlideContainer.addEventListener("click",function(e){e.stopPropagation(),e.preventDefault(),a.preview.dispatchEvent(new Event("next"))})),r.replaceChildren.apply(r,n(this.build())),this.show()}return o(e,[{key:"prev",value:function(){var e=this.parent.stories[this.position];this.active=!1,e.start_position--,e.start_position<0?(e.start_position=0,this.preview.dispatchEvent(new Event("prev"))):this.show()}},{key:"next",value:function(){var e=this.parent.stories[this.position];this.active=!1,e.start_position++,e.start_position>=e.slides.length?(e.start_position=0,this.preview.dispatchEvent(new Event("next"))):this.show()}},{key:"pause",value:function(){this.active=!1;var e=this.container.querySelector("video");e&&e.pause()}},{key:"resume",value:function(){this.active=!0;var e=this.container.querySelector("video");e&&e.play()}},{key:"build",value:function(){return[this.progress.build(),this.prevSlideContainer,this.container,this.nextSlideContainer]}},{key:"show",value:function(){var e=this;this.progress.show();var t=this.parent.stories[this.position],r=t.slides[t.start_position],n=0!==this.position&&this.parent.stories[this.position-1].slides[this.parent.stories[this.position-1].start_position],i=this.position!==this.parent.stories.length-1&&this.parent.stories[this.position+1].slides[this.parent.stories[this.position+1].start_position],o=void 0,a=void 0;switch(this.container.textContent="",r.type){case"image":d.match(r.background)?o=d.get(r.background).cloneNode(!0):(o=new Image,o.src=r.background),o.addEventListener("load",function(n){return e.active=!0,e.progress.items[t.start_position].animate(1e3*r.duration||5e3)});break;case"video":o=document.createElement("video"),o.src=r.background,o.setAttribute("playsinline","playsinline"),o.setAttribute("webkit-playsinline","webkit-playsinline"),o.muted=!0,o.poster=r.preview,o.addEventListener("loadeddata",function(r){e.active=!0,"block"===window.getComputedStyle(o,null).getPropertyValue("display")&&"block"!==window.getComputedStyle(e.carousel,null).getPropertyValue("display")&&(e.progress.items[t.start_position].animate(1e3*o.duration),o.play())}),o.addEventListener("waiting",function(){return e.active=!1}),o.addEventListener("playing",function(){return e.active=!0});break;default:return void this.next()}t.slides[t.start_position+1]&&!d.match("image"===t.slides[t.start_position+1].type?t.slides[t.start_position+1].background:t.slides[t.start_position+1].preview)&&d.add("image"===t.slides[t.start_position+1].type?t.slides[t.start_position+1].background:t.slides[t.start_position+1].preview),this.prevSlideContainer&&this.nextSlideContainer&&(this.prevSlideContainer.replaceChildren(n?this.buildPreview(n):""),this.nextSlideContainer.replaceChildren(i?this.buildPreview(i):"")),r.elements.find(function(e){return"products"===e.type})?(this.carousel.innerHTML="",a=this.parent.createItem("product-wrapper","ul"),r.elements.find(function(e){return"products"===e.type}).products.forEach(function(n){var i=e.parent.createItem("carousel-product","li"),o=e.parent.createItem("carousel-product-img","img"),s=e.parent.createItem("carousel-product-name","a"),c=e.parent.createItem("carousel-product-category","p"),l=e.parent.createItem("carousel-product-price","div"),u=e.parent.createItem("carousel-product-new-price","p"),d=e.parent.createItem("carousel-product-discount","p");o.src=n.picture,s.innerText=n.name,s.href=n.url,c.innerText=n.category.name,l.innerText=n.oldprice_formatted?n.oldprice_formatted:n.price_formatted,u.innerText=n.price_formatted,n.discount&&(d.innerText=n.discount,l.append(d)),i.append(o,s,c,l,n.oldprice?u:""),i.addEventListener("click",function(n){n.preventDefault(),n.stopPropagation(),e.parent.track("click",t.id,r.id).finally(function(){window.location=s.href})}),a.append(i)}),window.innerWidth<180*a.children.length&&(a.style.justifyContent="left"),this.carousel.append(a)):this.container.parentNode.parentNode.querySelector("span[class*='-element-show-products']")&&this.container.parentNode.parentNode.querySelector("span[class*='-element-show-products']").remove(),this.container.replaceChildren(o,document.createElement("div"));for(var s=0;s<r.elements.length;s++)this.buildElement(r.elements[s],t.id,r.id);this.parent.track("view",t.id,r.id),document.body.style.overflow="hidden"}},{key:"toggleCarousel",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=this.container.querySelector("video");"block"===this.carousel.style.display?(e.textContent=t.show_carousel||"Используемые товары",this.shadowLayer.style.display="none",this.carousel.style.display="none",this.active=!0,r&&r.play()):(e.textContent=t.hide_carousel||"Скрыть товары",this.shadowLayer.style.display="block",this.carousel.style.display="block",this.active=!1,r&&r.pause())}},{key:"buildElement",value:function(e,t,r){var n=this,i=void 0,o=void 0,a=function(e){e.preventDefault(),e.stopPropagation(),n.parent.track("click",t,r).finally(function(){window.location=i.href})};switch(e.type){case"button":i=this.parent.createItem("element-button","a"),i.href=e.link,i.textContent=e.title,i.style.fontWeight=e.text_bold?"bold":"normal",i.style.backgroundColor=e.background||null,i.style.color=e.color||null;break;case"header":i=this.parent.createItem("element-header","a"),i.href=e.link;var s=this.parent.createItem("element-header-avatar","img"),c=document.createElement("div"),l=this.parent.createItem("element-header-title"),u=this.parent.createItem("element-header-subtitle");s.src=e.icon,c.append(l,u),i.append(s,c),l.textContent=e.title,u.textContent=e.subtitle;break;case"products":o=this.parent.createItem("element-show-products","span");var d=this.parent.createItem("element-show-products-text","span"),h=this.parent.createItem("element-show-products-arrow-up","span");d.textContent=e.labels?e.labels.show_carousel:"Используемые товары",o.append(d,h),this.container.parentNode.parentNode.append(this.shadowLayer),this.container.parentNode.parentNode.append(this.carousel),o.addEventListener("click",function(t){t.stopPropagation(),t.preventDefault(),h.classList.toggle(n.parent.prefix()+"-element-show-products-arrow-up"),h.classList.toggle(n.parent.prefix()+"-element-show-products-arrow-down"),n.toggleCarousel(d,e.labels)}),this.container.querySelector("[class*='-button']")&&(this.container.querySelector("[class*='-button']").style.bottom="64px")}this.container.closest("div[class*='-background']").querySelector("[class*='-show-products']")&&this.container.closest("div[class*='-background']").querySelector("[class*='-show-products']").remove(),o&&this.container.closest("div[class*='-background']").append(o),i&&(i.addEventListener("click",a),this.container.append(i))}},{key:"buildPreview",value:function(e){var t=new Image;return t.src="image"===e.type?e.background:e.preview,t}}]),e}(),c=function(){function e(t,r){i(this,e),this.story=r,this.progress=t.parent.createItem("progress"),this.items=this.story.slides.map(function(){return new l(t)})}return o(e,[{key:"build",value:function(){var e;return(e=this.progress).append.apply(e,n(this.items.map(function(e){return e.build()}))),this.progress}},{key:"show",value:function(){var e=this;this.items.forEach(function(t,r){e.story.start_position>r?t.set(100):t.set(0)})}}]),e}(),l=function(){function e(t){i(this,e),this.div=t.parent.createItem("progress-item"),this.span=document.createElement("span"),this.div.append(this.span),this.progress=0,this.story_view=t}return o(e,[{key:"set",value:function(e){this.progress=e,this.span.style.width=this.progress+"%"}},{key:"animate",value:function(e){var t=this;this.clear(),this.story_view.parent.interval=setInterval(function(){t.story_view.active&&(t.progress+=100/e*100,t.progress>=100?(t.clear(),t.set(100),t.story_view.next()):t.set(t.progress))},100)}},{key:"clear",value:function(){this.story_view.parent.interval&&clearInterval(this.story_view.parent.interval)}},{key:"build",value:function(){return this.div}}]),e}(),u=function(){function e(){i(this,e),this.images=[]}return o(e,[{key:"add",value:function(e){var t=this;setTimeout(function(){var r=new Image;r.src=e,t.images.push({url:e,media:r})},100)}},{key:"get",value:function(e){return this.images.find(function(t){return t.url===e}).media}},{key:"match",value:function(e){return this.images.some(function(t){return t.url===e})}}]),e}(),d=new u;t.default=a},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=function(){function e(e,t){var r=[],n=!0,i=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(n=(a=s.next()).done)&&(r.push(a.value),!t||r.length!==t);n=!0);}catch(e){i=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(i)throw o}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),s=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),c=r(0),l=n(c),u=r(8),d=n(u),h=r(3),p=n(h),f=function(){function e(t,r,n,o){if(i(this,e),this.core=t,this.success=o,!n)throw Error("Track: empty data for track event");switch(this.queryParams={event:r,shop_id:this.core.shop.token,did:this.core.user.did,seance:l.default.get(this.core.label.fullName()+"_session_code")||null,segment:this.core.segment},r){case"view":if(this.buildParams(n),n.recommended_by&&(this.queryParams.recommended_by=n.recommended_by,!d.default.isTypeValid(n.recommended_by)))throw Error('Push: invalid type "'+n.recommended_by+'"');n.recommended_code&&(this.queryParams.recommended_code=n.recommended_code);break;case"category":this.queryParams.category_id=n;break;case"wish":case"remove_wish":this.buildParams(n);break;case"cart":n instanceof Array?(n=Object.entries(n.reduce(function(e,t){return t.id&&(t.amount=+t.amount||1)&&(e[t.id]?e[t.id]+=t.amount:e[t.id]=t.amount),e},{})).map(function(e){var t=a(e,2);return{id:t[0],amount:t[1]}}),n.forEach(this.buildParams.bind(this)),this.queryParams.full_cart=!0):(n.recommended_by&&(this.queryParams.recommended_by=n.recommended_by),n.recommended_code&&(this.queryParams.recommended_code=n.recommended_code),this.buildParams(n));break;case"remove_from_cart":this.buildParams(n);break;case"purchase":n.search_segment&&(this.queryParams.segment_ab=n.search_segment),n.order&&(this.queryParams.order_id=n.order),n.email&&(this.queryParams.email=n.email),n.phone&&(this.queryParams.phone=n.phone);for(var s=["order_price","order_cash","order_bonuses","order_delivery","order_discount","promocode","delivery_type","payment_type","tax_free"],c=0;c<9;c++){var u=s[c];n[u]&&(this.queryParams[u]=n[u])}if(!n.products||0===n.products.length)throw Error("Track: product list for purchase tracking is empty");n.products=Object.entries(n.products.reduce(function(e,t){var r=[t.id,t.line_id].join("|");return e[r]?e[r]=[e[r][0]+ +t.amount,t]:e[r]=[t.amount,t],e},{})).map(function(e){var t=a(e,2),r=(t[0],t[1]);return{id:r[1].id,amount:r[0],price:r[1].price,line_id:r[1].line_id}}),n.products.forEach(this.buildParams.bind(this));break;case"recone_click":case"recone_view":this.queryParams.campaign=n.id,this.queryParams.inventory=n.inventory,this.queryParams.position=n.position,n.recommended_by&&(this.queryParams.recommended_by=n.recommended_by);break;case"search":"string"==typeof n?this.queryParams.search_query=n:(this.queryParams.search_query=n.query,null!=n.results&&(this.queryParams.results=n.results.join(",")));break;default:throw Error("Track: Undefined event "+r)}}return s(e,[{key:"buildParams",value:function(e){var t={};if("object"===(void 0===e?"undefined":o(e))){if(!e.id)throw Error("Track: Item ID not set");t.id=e.id,e.amount&&(t.quantity=e.quantity||e.amount);for(var r=["price","line_id"],n=0;n<2;n++){var i=r[n];e[i]&&(t[i]=e[i])}(e.fashion_size||e.custom&&e.custom.fashion_size)&&(t.fashion_size=e.fashion_size||e.custom.fashion_size)}else{if("string"!=typeof e&&"number"!=typeof e)throw Error("Track: Incorrect syntax of the product argument: "+e+". Number, string or extended object supported only. Check manual.");t.id=e}this.queryParams.items||(this.queryParams.items=[]),this.queryParams.items.push(t)}},{key:"send",value:function(e,t){var r=this;if(e&&!this.queryParams.recommended_by&&(this.queryParams.recommended_by=e,!d.default.isTypeValid(e)))throw Error('Push: invalid type "'+e+'"');if(this.core.recommendedCode&&!this.queryParams.recommended_code&&(this.queryParams.recommended_code=this.core.recommendedCode),t&&(this.queryParams.source=JSON.stringify(t)),this.core.user.id&&(this.queryParams.user_id=this.core.user.id),this.core.user.email&&(this.queryParams.user_email=this.core.user.email),this.core.user.location&&(this.queryParams.user_location=this.core.user.location),t)switch(t.from){case"trigger_mail":case"digest_mail":this.queryParams[t.from+"_code"]=t.code;break;case"web_push_trigger":case"web_push_digest":this.queryParams[t.from+"_code"]=t.code}return this.core.ajax.sendWithRetry("post",this.core.api.getAPIUrl("/push"),this.queryParams).then(function(e){if("function"==typeof r.success&&r.success(),"object"===o(e.payload)&&Object.keys(e.payload).length>0){if("function"==typeof window.gtag){if("purchase"===e.payload.event){var t={transaction_id:e.payload.transaction_id,value:e.payload.value,currency:e.payload.currency,items:e.payload.items};window.gtag("event","purchase",t)}"view"===e.payload.event&&window.gtag("event","view_item",{items:e.payload.items}),"cart"===e.payload.event&&window.gtag("event","add_to_cart",{items:e.payload.items}),"remove_from_cart"===e.payload.event&&window.gtag("event","remove_from_cart",{items:e.payload.items})}"object"===o(e.payload.popup)&&p.default.prepare(r.core,e.payload.popup)}})}}],[{key:"trackUTM",value:function(e,t){var r={shop_id:e.shop.token,did:e.user.did,seance:l.default.get(e.label.fullName()+"_session_code")||null,utm:{}};for(var n in t)r.utm[n]=t[n];return e.ajax.sendWithRetry("post",e.api.getAPIUrl("/push/utm"),r)}}]),e}();t.default=f},function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),a=r(1),s=function(e){return e&&e.__esModule?e:{default:e}}(a),c=function(){function e(t){n(this,e),this.core=t}return o(e,[{key:"productAvailable",value:function(e){this.makeRequest(e,"/subscriptions/subscribe_for_product_available")}},{key:"productPriceDecrease",value:function(e){if(!e.price||isNaN(parseFloat(e.price))||parseFloat(e.price)<1)throw Error("Incorrect price field");this.makeRequest(e,"/subscriptions/subscribe_for_product_price")}},{key:"productAvailableUnsubscribe",value:function(e){this.core.ajax.sendWithRetry("post",this.core.api.getAPIUrl("/subscriptions/unsubscribe_from_product_available"),e)}},{key:"productPriceDecreaseUnsubscribe",value:function(e){this.core.ajax.sendWithRetry("post",this.core.api.getAPIUrl("/subscriptions/unsubscribe_from_product_price"),e)}},{key:"makeRequest",value:function(e,t){var r=this,n={shop_id:this.core.shop.token,did:this.core.user.did,item_id:e.item};switch("string"==typeof e.email&&s.default.validEmail(e.email)&&(n.email=e.email),e.price&&(n.price=e.price),e.properties&&(n.properties={},e.properties.barcode&&(n.properties.barcode=e.properties.barcode),e.properties.fashion_size&&(n.properties.fashion_size=e.properties.fashion_size)),!n.email&&!e.popup&&this.core.web_push&&this.core.web_push.enabled()&&this.core.web_push.supported()?n.type="webpush":n.type=e.popup,n.email&&e.webpush&&(n.type="all_channels"),n.type){case"webpush":this.core.web_push&&this.core.web_push.subscribe().then(function(){r.core.ajax.sendWithRetry("post",r.core.api.getAPIUrl(t),n)});break;case"all_channels":n.type="email",this.core.ajax.sendPost(this.core.api.getAPIUrl(t),n).then(function(){r.core.web_push&&r.core.web_push.enabled()&&r.core.web_push.supported()&&(n.type="webpush",delete n.email,r.core.web_push.subscribe().then(function(){r.core.ajax.sendPost(r.core.api.getAPIUrl(t),n)}))});break;default:n.type="email",(n.email||this.core.shop.has_email)&&this.core.ajax.sendWithRetry("post",this.core.api.getAPIUrl(t),n)}}},{key:"fetch",value:function(e,t){if(void 0===t.item)throw Error("Incorrect item field");switch(e){case"product_available":return this.productAvailable(t);case"product_price_decrease":return this.productPriceDecrease(t)}}},{key:"fetchUnsubscribe",value:function(e,t){if(void 0===t.item_ids||!Array.isArray(t.item_ids))throw Error("Incorrect item_ids field");if("string"!=typeof t.email||!s.default.validEmail(t.email))throw Error("Incorrect email field");switch(t=Object.assign(t,{shop_id:this.core.shop.token,did:this.core.user.did,item_ids:t.item_ids.join(",")}),e){case"product_available":return this.productAvailableUnsubscribe(t);case"product_price_decrease":return this.productPriceDecreaseUnsubscribe(t)}}},{key:"fetchCheck",value:function(e,t,r,n){if(!(["string","number"].indexOf(i(t.item))+1))return this.core.logger.warn('The "item" parameter is missing or has the correct type');delete(t=Object.assign(t,{shop_id:this.core.shop.token,did:this.core.user.did,item_id:t.item})).item;var o=null;switch(e){case"product_available":o=this.core.api.getAPIUrl("/products/check_product_available_subscription");break;case"product_price_decrease":o=this.core.api.getAPIUrl("/products/check_price_drop_subscription");break;default:return this.core.logger.warn('Undefined "'+e+'" method')}this.core.ajax.sendGet(o,t).then(r).catch(function(e){if("function"!=typeof n)throw Error(e);n(e)})}}]),e}();t.default=c},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),s=r(0),c=n(s),l=r(4),u=n(l),d=function(){function e(t,r){i(this,e),this.core=t,this.settings=r,this.settings.public_key&&"string"==typeof this.settings.public_key&&(this.settings.public_key=this.urlBase64ToUint8Array(this.settings.public_key)),this.supported()&&this.registerServiceWorker()}return a(e,[{key:"supported",value:function(){return!!this.enabled()&&(-1===navigator.userAgent.toLowerCase().indexOf("msie")&&(e.supportedSafari()&&this.enabledSafari()||e.supportedOpera()||e.supportedWebkit()?"denied"!==this.permission()||(this.core.logger.debug("The user has blocked notifications.",this),!1):(this.core.logger.debug("Notifications aren't supported.",this),!1)))}},{key:"enabled",value:function(){return this.settings&&("localhost"===document.location.hostname||"https:"===document.location.protocol)&&!this.core.browserIsPrivateMode&&("417dfce51c4cc3cc2fe3da5480db10"!==this.core.shop.token||"A"===c.default.get(this.core.label.fullName()+"VisitorSegment"))}},{key:"enabledSafari",value:function(){return this.settings&&this.settings.safari_enabled}},{key:"registerServiceWorker",value:function(){var t=this;if(e.supportedSafari()){"granted"===this.safariPermission().permission&&(this.subscription=!0)}else navigator.serviceWorker.register(this.settings.service_worker||"/push_sw.js").then(function(e){t.core.logger.debug("Service Worker is ready",t);try{navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({did:t.core.user.did,shop_id:t.core.shop.token})}catch(e){t.core.logger.debug("Service Worker error: "+e,t)}"granted"===Notification.permission&&e.pushManager.getSubscription().then(function(r){if(!r||JSON.stringify(new Uint8Array(r.options.applicationServerKey))===JSON.stringify(new Uint8Array(t.settings.public_key)))return r?t.sendRegistrationToken(JSON.stringify(r.toJSON())):t.requestSubscribe(e);t.core.logger.debug("applicationServerKey in subscription does not match settings.public_key, resubscribe",t),r.unsubscribe().then(function(r){return t.requestSubscribe(e)}),r=null})}).catch(function(e){t.core.logger.error("Service Worker error: "+e)})}},{key:"subscribe",value:function(){var t=this,r=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.supported())return e.supportedSafari()?this.checkSafariRemotePermission(this.safariPermission()):navigator.serviceWorker.ready.then(function(e){return e.pushManager.getSubscription().then(function(i){return i?function(e){return n?JSON.stringify(e.toJSON()):t.sendRegistrationToken(JSON.stringify(e.toJSON()),r)}(i):"default"===Notification.permission?Notification.requestPermission().then(function(r){if("granted"!==r)throw"denied"===r&&t.unsubscribed(),Error("Bad permission result");return t.requestSubscribe(e,n)}):void 0})});this.core.logger.error("Web push subscription not supported in the current browser")}},{key:"urlBase64ToUint8Array",value:function(e){for(var t="=".repeat((4-e.length%4)%4),r=(e+t).replace(/-/g,"+").replace(/_/g,"/"),n=window.atob(r),i=new Uint8Array(n.length),o=0;o<n.length;++o)i[o]=n.charCodeAt(o);return i}},{key:"requestSubscribe",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:new Uint8Array(this.settings.public_key)}).then(function(e){return r?JSON.stringify(e.toJSON()):t.sendRegistrationToken(JSON.stringify(e.toJSON()),!0)}).catch(function(e){t.core.logger.error(e,t)})}},{key:"unsubscribed",value:function(){var e=this;this.core.ajax.sendWithRetry("post",this.core.api.getAPIUrl("/web_push_subscriptions/decline"),{shop_id:this.core.shop.token,did:this.core.user.did}).then(function(){e.core.logger.debug("пользователь отказался от подписки, данные успешно отправлены на сервер.")})}},{key:"safariPermission",value:function(){return window.safari.pushNotification.permission(this.settings.safari_id)}},{key:"permission",value:function(){return(e.supportedSafari()?this.safariPermission():Notification).permission}},{key:"isSubscribed",value:function(){return this.supported()&&"granted"===this.permission()}},{key:"checkSafariRemotePermission",value:function(e){var t=this;return new Promise(function(r,n){if("default"===e.permission)return t.safariRequestPermission();if("denied"===e.permission)t.core.logger.debug("The user has blocked notifications.",t),t.unsubscribed(),n();else if("granted"===e.permission)return t.initialized=!0,t.subscription=!0,t.sendRegistrationToken(JSON.stringify({browser:"safari",token:e.deviceToken})).then(r)})}},{key:"safariRequestPermission",value:function(){var e=this;return new Promise(function(t,r){window.safari.pushNotification.requestPermission(e.core.api.getAPIUrl("/web_push_subscriptions/safari_webpush?shop_id="+e.core.shop.token+"&type="),e.settings.safari_id,{},function(n){e.checkSafariRemotePermission(n).then(t).catch(r)})})}},{key:"sendRegistrationToken",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];arguments.length>2&&void 0!==arguments[2]&&arguments[2];return new Promise(function(n,i){t.core.logger.debug("token: "+e+", force: "+r,t);var o=new Date,a=o.getFullYear()+":"+o.getMonth()+":"+o.getDate();r||localStorage.getItem(t.core.label.fullName()+"_webpush_sync")!==a?(localStorage.setItem(t.core.label.fullName()+"_webpush_sync",a),u.default.set(t.core,{web_push_token:e},function(){return n(e)},i)):n(e)})}}],[{key:"supportedWebkit",value:function(){return"serviceWorker"in navigator&&"showNotification"in ServiceWorkerRegistration.prototype&&"PushManager"in window}},{key:"supportedSafari",value:function(){return"safari"in window&&"object"==o(window.safari)&&"pushNotification"in window.safari}},{key:"supportedOpera",value:function(){return!(window.navigator.userAgent.indexOf("OPR")>-1||window.navigator.userAgent.indexOf("Opera")>-1)&&e.supportedWebkit()}}]),e}();t.default=d},function(e,t,r){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=function(){function e(t,r,i,o){n(this,e),this.env=t,this._name=r,this._full_name=i,this._gdpr=o}return i(e,[{key:"name",value:function(){return this._name}},{key:"fullName",value:function(){return this._full_name}},{key:"gdpr",value:function(){return this._gdpr}}]),e}();t.default=o},function(e,t,r){(function(t){function r(e,r){function i(e){setTimeout(function(){a.onmessage({data:e})},0)}var o,a=this;if(r=r||{},n)return o=(""+e).trim().match(/^function\s*\w*\s*\([\w\s,]*\)\s*{([\w\W]*?)}$/)[1],new t.Worker(t.URL.createObjectURL(new t.Blob([o],{type:"text/javascript"})));this.self=r,this.self.postMessage=i,setTimeout(e.bind(r,r),0)}var n=!!(t===t.window&&t.URL&&t.Blob&&t.Worker);r.prototype.postMessage=function(e){var t=this;setTimeout(function(){t.self.onmessage({data:e})},0)},e.exports=r}).call(t,r(10))},function(e,t,r){"use strict";e.exports=r(36)},function(e,t,r){"use strict";var n=r(2);e.exports=n,n.prototype.done=function(e,t){(arguments.length?this.then.apply(this,arguments):this).then(null,function(e){setTimeout(function(){throw e},0)})}},function(e,t,r){"use strict";function n(e){var t=new i(i._61);return t._65=1,t._55=e,t}var i=r(2);e.exports=i;var o=n(!0),a=n(!1),s=n(null),c=n(void 0),l=n(0),u=n("");i.resolve=function(e){if(e instanceof i)return e;if(null===e)return s;if(void 0===e)return c;if(!0===e)return o;if(!1===e)return a;if(0===e)return l;if(""===e)return u;if("object"==typeof e||"function"==typeof e)try{var t=e.then;if("function"==typeof t)return new i(t.bind(e))}catch(e){return new i(function(t,r){r(e)})}return n(e)},i.all=function(e){var t=Array.prototype.slice.call(e);return new i(function(e,r){function n(a,s){if(s&&("object"==typeof s||"function"==typeof s)){if(s instanceof i&&s.then===i.prototype.then){for(;3===s._65;)s=s._55;return 1===s._65?n(a,s._55):(2===s._65&&r(s._55),void s.then(function(e){n(a,e)},r))}var c=s.then;if("function"==typeof c){return void new i(c.bind(s)).then(function(e){n(a,e)},r)}}t[a]=s,0==--o&&e(t)}if(0===t.length)return e([]);for(var o=t.length,a=0;a<t.length;a++)n(a,t[a])})},i.reject=function(e){return new i(function(t,r){r(e)})},i.race=function(e){return new i(function(t,r){e.forEach(function(e){i.resolve(e).then(t,r)})})},i.prototype.catch=function(e){return this.then(null,e)}},function(e,t,r){"use strict";var n=r(2);e.exports=n,n.prototype.finally=function(e){return this.then(function(t){return n.resolve(e()).then(function(){return t})},function(t){return n.resolve(e()).then(function(){throw t})})}},function(e,t,r){"use strict";e.exports=r(2),r(33),r(35),r(34),r(37),r(38)},function(e,t,r){"use strict";function n(e,t){for(var r=[],n=0;n<t;n++)r.push("a"+n);var i="return function ("+r.join(",")+") {var self = this;return new Promise(function (rs, rj) {var res = fn.call("+["self"].concat(r).concat([s]).join(",")+');if (res &&(typeof res === "object" || typeof res === "function") &&typeof res.then === "function") {rs(res);}});};';return Function(["Promise","fn"],i)(o,e)}function i(e){for(var t=Math.max(e.length-1,3),r=[],n=0;n<t;n++)r.push("a"+n);var i="return function ("+r.join(",")+") {var self = this;var args;var argLength = arguments.length;if (arguments.length > "+t+") {args = new Array(arguments.length + 1);for (var i = 0; i < arguments.length; i++) {args[i] = arguments[i];}}return new Promise(function (rs, rj) {var cb = "+s+";var res;switch (argLength) {"+r.concat(["extra"]).map(function(e,t){return"case "+t+":res = fn.call("+["self"].concat(r.slice(0,t)).concat("cb").join(",")+");break;"}).join("")+'default:args[argLength] = cb;res = fn.apply(self, args);}if (res &&(typeof res === "object" || typeof res === "function") &&typeof res.then === "function") {rs(res);}});};';return Function(["Promise","fn"],i)(o,e)}var o=r(2),a=r(12);e.exports=o,o.denodeify=function(e,t){return"number"==typeof t&&t!==1/0?n(e,t):i(e)};var s="function (err, res) {if (err) { rj(err); } else { rs(res); }}";o.nodeify=function(e){return function(){var t=Array.prototype.slice.call(arguments),r="function"==typeof t[t.length-1]?t.pop():null,n=this;try{return e.apply(this,arguments).nodeify(r,n)}catch(e){if(null===r||void 0===r)return new o(function(t,r){r(e)});a(function(){r.call(n,e)})}}},o.prototype.nodeify=function(e,t){if("function"!=typeof e)return this;this.then(function(r){a(function(){e.call(t,null,r)})},function(r){a(function(){e.call(t,r)})})}},function(e,t,r){"use strict";var n=r(2);e.exports=n,n.enableSynchronous=function(){n.prototype.isPending=function(){return 0==this.getState()},n.prototype.isFulfilled=function(){return 1==this.getState()},n.prototype.isRejected=function(){return 2==this.getState()},n.prototype.getValue=function(){if(3===this._65)return this._55.getValue();if(!this.isFulfilled())throw Error("Cannot get a value of an unfulfilled promise.");return this._55},n.prototype.getReason=function(){if(3===this._65)return this._55.getReason();if(!this.isRejected())throw Error("Cannot get a rejection reason of a non-rejected promise.");return this._55},n.prototype.getState=function(){return 3===this._65?this._55.getState():-1===this._65||-2===this._65?0:this._65}},n.disableSynchronous=function(){n.prototype.isPending=void 0,n.prototype.isFulfilled=void 0,n.prototype.isRejected=void 0,n.prototype.getValue=void 0,n.prototype.getReason=void 0,n.prototype.getState=void 0}},function(e,t,r){"use strict";var n=function(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}};e.exports=function(e,t,r,i){return t=t||"&",r=r||"=",null===e&&(e=void 0),"object"==typeof e?Object.keys(e).map(function(i){var o=encodeURIComponent(n(i))+r;return Array.isArray(e[i])?e[i].map(function(e){return o+encodeURIComponent(n(e))}).join(t):o+encodeURIComponent(n(e[i]))}).join(t):i?encodeURIComponent(n(i))+r+encodeURIComponent(n(e)):""}},function(e,t,r){e.exports=r(11)}])});