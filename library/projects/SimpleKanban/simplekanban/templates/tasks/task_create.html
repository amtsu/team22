{#{% extends 'base.html' %}#}
{#{% load static %}#}
{##}
{#{% block title %}Создание задачи - SuperKanban{% endblock %}#}
{##}
{#{% block content %}#}
{#<div class="container">#}
{#  <div class="row">#}
{#    <div class="col-lg-8">#}
{##}
{#      <!-- Форма создания задачи -->#}
{#      <section id="task-form" class="section">#}
{#        <div class="container">#}
{#          <form method="post">#}
{#            {% csrf_token %}#}
{#            <h4>Создаем задачу</h4>#}
{#            <p>Необходимо заполнить следующие поля. Обязательные поля помечены *</p>#}
{##}
{#            {{ form.as_p }}#}
{##}
{#            <!-- Подзадачи -->#}
{#            <h4>Подзадачи</h4>#}
{#            <p>Добавьте подзадачи, если необходимо:</p>#}
{##}
{#            {{ subtasks.management_form }}#}
{#            {% for subtask_form in subtasks %}#}
{#              <div class="row">#}
{#                <div class="col-md-6 form-group">#}
{#                  {{ subtask_form.title }}#}
{#                </div>#}
{#                <div class="col-md-6 form-group">#}
{#                  {{ subtask_form.task }}#}
{#                </div>#}
{#                <div class="col-md-6 form-group">#}
{#                  {{ subtask_form.executor }}#}
{#                </div>#}
{#                <div class="col-md-6 form-group">#}
{#                  {{ subtask_form.due_date }}#}
{#                </div>#}
{#                <div class="col-md-6 form-group">#}
{#                  {{ subtask_form.description }}#}
{#                </div>#}
{#              </div>#}
{#            {% endfor %}#}
{##}
{#            <!-- Кнопка для добавления подзадач -->#}
{#            <div class="text-center mb-4">#}
{#              <button type="button" class="btn btn-secondary" onclick="addSubtask()">Добавить подзадачу</button>#}
{#            </div>#}
{##}
{#            <div class="text-center">#}
{#              <button type="submit" class="btn btn-primary">Создать задачу и подзадачи</button>#}
{#            </div>#}
{#          </form>#}
{#        </div>#}
{#      </section>#}
{##}
{#    </div>#}
{#  </div>#}
{#</div>#}
{##}
{#<script>#}
{#  // Функция для добавления подзадач#}
{#  let subtaskCount = {{ subtasks.management_form.count|default:0 }};#}
{#  function addSubtask() {#}
{#    subtaskCount++;#}
{##}
{#    const subtaskHtml = `#}
{#      <div class="row">#}
{#        <div class="col-md-6 form-group">#}
{#          <label for="id_subtask-${subtaskCount}-title">Название подзадачи*</label>#}
{#          <input type="text" name="subtask-${subtaskCount}-title" required class="form-control" id="id_subtask-${subtaskCount}-title">#}
{#        </div>#}
{#        <div class="col-md-6 form-group">#}
{#          <label for="id_subtask-${subtaskCount}-executor">Исполнитель*</label>#}
{#          <select name="subtask-${subtaskCount}-executor" required class="form-control" id="id_subtask-${subtaskCount}-executor">#}
{#            <option value="">Выберите исполнителя</option>#}
{#            {% for user in company_users %}#}
{#              <option value="{{ user.id }}">{{ user.username }}</option>#}
{#            {% endfor %}#}
{#          </select>#}
{#        </div>#}
{#        <div class="col-md-6 form-group">#}
{#          <label for="id_subtask-${subtaskCount}-due_date">Дата выполнения*</label>#}
{#          <input type="date" name="subtask-${subtaskCount}-due_date" required class="form-control" id="id_subtask-${subtaskCount}-due_date">#}
{#        </div>#}
{#        <div class="col-md-6 form-group">#}
{#          <label for="id_subtask-${subtaskCount}-description">Описание подзадачи</label>#}
{#          <textarea name="subtask-${subtaskCount}-description" class="form-control" id="id_subtask-${subtaskCount}-description"></textarea>#}
{#        </div>#}
{#      </div>#}
{#    `;#}
{##}
{#    const container = document.getElementById("subtasks-container");#}
{#    container.insertAdjacentHTML('beforeend', subtaskHtml);#}
{#  }#}
{#</script>#}
{##}
{#{% endblock %}#}

{% extends 'base.html' %}
{% load static %}

{% block title %}Создание задачи - SuperKanban{% endblock %}

{% block content %}
<div class="container">
  <div class="row">
    <div class="col-lg-8">
      <!-- Форма создания задачи -->
      <section id="task-form" class="section">
        <div class="container">
          <form method="post">
            {% csrf_token %}
            <h4>Создаем задачу</h4>
            <p>Необходимо заполнить следующие поля. Обязательные поля помечены *</p>

            {{ form.as_p }}

            <!-- Подзадачи -->
            <h4>Подзадачи</h4>
            <p>Добавьте подзадачи, если необходимо:</p>

            {{ subtask_formset.management_form }}

            <div id="subtask-formset">
                {% for form in subtask_formset %}
                <div class="row mb-3">
                    <div class="col-md-6 form-group">
                        {{ form.title }}
                    </div>
                    <div class="col-md-6 form-group">
                        {{ form.task }}
                    </div>
                    <div class="col-md-6 form-group">
                        {{ form.executor }}
                    </div>
                    <div class="col-md-6 form-group">
                        {{ form.due_date }}
                    </div>
                    <div class="col-md-6 form-group">
                        {{ form.description }}
                    </div>
                    <div class="col-md-6 form-group">
                        <button type="button" class="btn btn-danger" onclick="removeSubtask(this)">Удалить</button>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Кнопка для добавления подзадач -->
            <div class="text-center mb-4">
              <button type="button" class="btn btn-secondary" onclick="addSubtask()">Добавить подзадачу</button>
            </div>

            <div class="text-center">
              <button type="submit" class="btn btn-primary">Создать задачу и подзадачи</button>
            </div>
          </form>
        </div>
      </section>
    </div>
  </div>
</div>

<script>
  // Индекс для новых форм в formset
  let formIndex = {{ subtask_formset.management_form.initial.TOTAL_FORMS }};

  // Функция для добавления новой подзадачи
  function addSubtask() {
    const newForm = document.createElement('div');
    newForm.classList.add('form-row', 'mb-3');

    // Создаем HTML код для новой подзадачи
    newForm.innerHTML = `
      <div class="col-md-6 form-group">
        <label for="id_subtask-${formIndex}-title">Название подзадачи*</label>
        <input type="text" name="subtasks-${formIndex}-title" required class="form-control" id="id_subtask-${formIndex}-title">
      </div>
      <div class="col-md-6 form-group">
        <label for="id_subtask-${formIndex}-task">Задача*</label>
        <select name="subtasks-${formIndex}-task" required class="form-control" id="id_subtask-${formIndex}-task">
          {% for task in tasks %}
            <option value="{{ task.id }}">{{ task.title }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-6 form-group">
        <label for="id_subtask-${formIndex}-executor">Исполнитель*</label>
        <select name="subtasks-${formIndex}-executor" required class="form-control" id="id_subtask-${formIndex}-executor">
          <option value="">Выберите исполнителя</option>
          {% for user in company_users %}
            <option value="{{ user.id }}">{{ user.username }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-6 form-group">
        <label for="id_subtask-${formIndex}-due_date">Дата выполнения*</label>
        <input type="date" name="subtasks-${formIndex}-due_date" required class="form-control" id="id_subtask-${formIndex}-due_date">
      </div>
      <div class="col-md-6 form-group">
        <label for="id_subtask-${formIndex}-description">Описание подзадачи</label>
        <textarea name="subtasks-${formIndex}-description" class="form-control" id="id_subtask-${formIndex}-description"></textarea>
      </div>
      <div class="col-md-6 form-group">
        <button type="button" class="btn btn-danger" onclick="removeSubtask(this)">Удалить</button>
      </div>
    `;

    // Добавляем новый элемент формы в контейнер
    document.getElementById('subtask-formset').appendChild(newForm);

    // Обновляем количество форм в formset
    formIndex++;
    document.querySelector('input[name="subtasks-TOTAL_FORMS"]').value = formIndex;
  }

  // Функция для удаления подзадачи
  function removeSubtask(button) {
    const formRow = button.closest('.form-row');
    formRow.remove();

    // Обновляем количество форм в formset
    formIndex--;
    document.querySelector('input[name="subtasks-TOTAL_FORMS"]').value = formIndex;
  }
</script>

{% endblock %}
